<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="深層学習 (deep learning) は民主化が進んでおり，様々なオープンソースのパッケージが開発されている． ここではfastaiを紹介する。">

<title>analytics2 - fastaiによる深層学習</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>
<script src="https://unpkg.com/@jupyter-widgets/html-manager@*/dist/embed-amd.js" crossorigin="anonymous"></script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="analytics2 - fastaiによる深層学習">
<meta property="og:description" content="深層学習 (deep learning) は民主化が進んでおり，様々なオープンソースのパッケージが開発されている． ここではfastaiを紹介する。">
<meta property="og:image" content="https://scmopt.github.io/analytics2/16fastai_files/figure-html/cell-11-output-1.png">
<meta property="og:site-name" content="analytics2">
<meta property="og:image:height" content="735">
<meta property="og:image:width" content="716">
<meta name="twitter:title" content="analytics2 - fastaiによる深層学習">
<meta name="twitter:description" content="深層学習 (deep learning) は民主化が進んでおり，様々なオープンソースのパッケージが開発されている． ここではfastaiを紹介する。">
<meta name="twitter:image" content="https://scmopt.github.io/analytics2/16fastai_files/figure-html/cell-11-output-1.png">
<meta name="twitter:image-height" content="735">
<meta name="twitter:image-width" content="716">
<meta name="twitter:card" content="summary_large_image">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg navbar-dark ">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">analytics2</span>
    </a>
  </div>
        <div class="quarto-navbar-tools ms-auto">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./16fastai.html">fastaiによる深層学習</a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">データサイエンス練習問題集 II</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./05transformers.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Transformers</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./16fastai.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">fastaiによる深層学習</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./17neuralprophet.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">NeuralProphetによる時系列データの予測</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./30chatgpt.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">ChatGPTを用いたプロンプト・エンジニアリング</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#深層学習とは" id="toc-深層学習とは" class="nav-link active" data-scroll-target="#深層学習とは">深層学習とは</a></li>
  <li><a href="#深層学習の歴史" id="toc-深層学習の歴史" class="nav-link" data-scroll-target="#深層学習の歴史">深層学習の歴史</a></li>
  <li><a href="#なぜ深層学習がうまくいくようになったのか" id="toc-なぜ深層学習がうまくいくようになったのか" class="nav-link" data-scroll-target="#なぜ深層学習がうまくいくようになったのか">なぜ深層学習がうまくいくようになったのか？</a></li>
  <li><a href="#fastaiとは" id="toc-fastaiとは" class="nav-link" data-scroll-target="#fastaiとは">fastaiとは</a></li>
  <li><a href="#fastaiのインストール" id="toc-fastaiのインストール" class="nav-link" data-scroll-target="#fastaiのインストール">fastaiのインストール</a></li>
  <li><a href="#mnist_sample" id="toc-mnist_sample" class="nav-link" data-scroll-target="#mnist_sample">MNIST_SAMPLE</a>
  <ul class="collapse">
  <li><a href="#resnet" id="toc-resnet" class="nav-link" data-scroll-target="#resnet">ResNet</a></li>
  <li><a href="#転移学習" id="toc-転移学習" class="nav-link" data-scroll-target="#転移学習">転移学習</a></li>
  <li><a href="#学習率の調整" id="toc-学習率の調整" class="nav-link" data-scroll-target="#学習率の調整">学習率の調整</a></li>
  </ul></li>
  <li><a href="#cifar10" id="toc-cifar10" class="nav-link" data-scroll-target="#cifar10">Cifar10</a></li>
  <li><a href="#pets" id="toc-pets" class="nav-link" data-scroll-target="#pets">PETS</a></li>
  <li><a href="#表形式データ" id="toc-表形式データ" class="nav-link" data-scroll-target="#表形式データ">表形式データ</a>
  <ul class="collapse">
  <li><a href="#例題-サラリーの分類" id="toc-例題-サラリーの分類" class="nav-link" data-scroll-target="#例題-サラリーの分類">例題： サラリーの分類</a></li>
  <li><a href="#例題住宅価格の予測" id="toc-例題住宅価格の予測" class="nav-link" data-scroll-target="#例題住宅価格の予測">例題：住宅価格の予測</a></li>
  <li><a href="#問題スパム" id="toc-問題スパム" class="nav-link" data-scroll-target="#問題スパム">問題（スパム）</a></li>
  <li><a href="#問題毒キノコ" id="toc-問題毒キノコ" class="nav-link" data-scroll-target="#問題毒キノコ">問題（毒キノコ）</a></li>
  <li><a href="#問題タイタニック" id="toc-問題タイタニック" class="nav-link" data-scroll-target="#問題タイタニック">問題（タイタニック）</a></li>
  <li><a href="#問題胸部癌" id="toc-問題胸部癌" class="nav-link" data-scroll-target="#問題胸部癌">問題（胸部癌）</a></li>
  <li><a href="#問題部屋" id="toc-問題部屋" class="nav-link" data-scroll-target="#問題部屋">問題（部屋）</a></li>
  </ul></li>
  <li><a href="#画像データ" id="toc-画像データ" class="nav-link" data-scroll-target="#画像データ">画像データ</a>
  <ul class="collapse">
  <li><a href="#複数のラベルを生成する分類" id="toc-複数のラベルを生成する分類" class="nav-link" data-scroll-target="#複数のラベルを生成する分類">複数のラベルを生成する分類</a></li>
  <li><a href="#画像から人の頭の中心を当てる回帰" id="toc-画像から人の頭の中心を当てる回帰" class="nav-link" data-scroll-target="#画像から人の頭の中心を当てる回帰">画像から人の頭の中心を当てる回帰</a></li>
  </ul></li>
  <li><a href="#協調フィルタリング" id="toc-協調フィルタリング" class="nav-link" data-scroll-target="#協調フィルタリング">協調フィルタリング</a></li>
  <li><a href="#意味分割" id="toc-意味分割" class="nav-link" data-scroll-target="#意味分割">意味分割</a></li>
  <li><a href="#テキストデータ" id="toc-テキストデータ" class="nav-link" data-scroll-target="#テキストデータ">テキストデータ</a></li>
  <li><a href="#画像生成" id="toc-画像生成" class="nav-link" data-scroll-target="#画像生成">画像生成</a>
  <ul class="collapse">
  <li><a href="#問題dalle-2" id="toc-問題dalle-2" class="nav-link" data-scroll-target="#問題dalle-2">問題（DALL・E 2）</a></li>
  <li><a href="#問題hagging-face-diffusers" id="toc-問題hagging-face-diffusers" class="nav-link" data-scroll-target="#問題hagging-face-diffusers">問題（Hagging Face Diffusers）</a></li>
  <li><a href="#問題-hagging-face" id="toc-問題-hagging-face" class="nav-link" data-scroll-target="#問題-hagging-face">問題 （Hagging Face)</a></li>
  </ul></li>
  <li><a href="#深層学習の基礎を図で解説" id="toc-深層学習の基礎を図で解説" class="nav-link" data-scroll-target="#深層学習の基礎を図で解説">深層学習の基礎を図で解説</a>
  <ul class="collapse">
  <li><a href="#畳み込みニューラルネット" id="toc-畳み込みニューラルネット" class="nav-link" data-scroll-target="#畳み込みニューラルネット">畳み込みニューラルネット</a></li>
  <li><a href="#回帰型ニューラルネット" id="toc-回帰型ニューラルネット" class="nav-link" data-scroll-target="#回帰型ニューラルネット">回帰型ニューラルネット</a></li>
  <li><a href="#長短期記憶" id="toc-長短期記憶" class="nav-link" data-scroll-target="#長短期記憶">長短期記憶</a></li>
  <li><a href="#埋め込みニューラルネット" id="toc-埋め込みニューラルネット" class="nav-link" data-scroll-target="#埋め込みニューラルネット">埋め込みニューラルネット</a></li>
  <li><a href="#自己アテンション" id="toc-自己アテンション" class="nav-link" data-scroll-target="#自己アテンション">自己アテンション</a></li>
  </ul></li>
  <li><a href="#実践的な深層学習のレシピと背景にある理論" id="toc-実践的な深層学習のレシピと背景にある理論" class="nav-link" data-scroll-target="#実践的な深層学習のレシピと背景にある理論">実践的な深層学習のレシピと背景にある理論</a>
  <ul class="collapse">
  <li><a href="#訓練検証テスト集合" id="toc-訓練検証テスト集合" class="nav-link" data-scroll-target="#訓練検証テスト集合">訓練、検証、テスト集合</a></li>
  <li><a href="#バイアスとバリアンス-過剰適合と不足適合" id="toc-バイアスとバリアンス-過剰適合と不足適合" class="nav-link" data-scroll-target="#バイアスとバリアンス-過剰適合と不足適合">バイアスとバリアンス / 過剰適合と不足適合</a></li>
  <li><a href="#深層学習のレシピ" id="toc-深層学習のレシピ" class="nav-link" data-scroll-target="#深層学習のレシピ">深層学習のレシピ</a></li>
  <li><a href="#l2正則化重み減衰が過剰適合を削減する直感的な理由" id="toc-l2正則化重み減衰が過剰適合を削減する直感的な理由" class="nav-link" data-scroll-target="#l2正則化重み減衰が過剰適合を削減する直感的な理由">L2正則化（重み減衰）が過剰適合を削減する直感的な理由</a></li>
  <li><a href="#ハイパーパラメータのチューニング" id="toc-ハイパーパラメータのチューニング" class="nav-link" data-scroll-target="#ハイパーパラメータのチューニング">ハイパーパラメータのチューニング</a></li>
  <li><a href="#評価尺度メトリクス" id="toc-評価尺度メトリクス" class="nav-link" data-scroll-target="#評価尺度メトリクス">評価尺度（メトリクス）</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><div><i class="bi bi-github"></i></div><div class="action-links"><p><a href="https://github.com/scmopt/analytics2/issues/new" class="toc-action">Report an issue</a></p></div></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">fastaiによる深層学習</h1>
</div>

<div>
  <div class="description">
    深層学習 (deep learning) は民主化が進んでおり，様々なオープンソースのパッケージが開発されている． ここではfastaiを紹介する。
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  

</header>

<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">

        <iframe width="200" height="150" src="https://www.youtube.com/embed/3w7896ke-To" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">

        <iframe width="200" height="150" src="https://www.youtube.com/embed/VKc7NGZru-Y" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
<div class="cell">
<div class="cell-output cell-output-display">

        <iframe width="200" height="150" src="https://www.youtube.com/embed/iJVkwofNY9E" frameborder="0" allowfullscreen=""></iframe>
        
</div>
</div>
<section id="深層学習とは" class="level2">
<h2 class="anchored" data-anchor-id="深層学習とは">深層学習とは</h2>
<p>深層学習とは多くの隠れ層（後で説明する）をもつニューラルネットである． ニューラルネットとは（機械学習のところで簡単に触れたように），</p>
<ol type="1">
<li>訓練データを複数の階層から構成されるモデルに入力，</li>
<li>上層からの重み付き和（線形変換）に活性化関数を適用して，下層に流す，</li>
<li>最下層では損出関数によって誤差を評価，</li>
<li>誤差の情報から勾配を計算，</li>
<li>勾配の情報を用いて，重み（パラメータ）の更新，</li>
</ol>
<p>を繰り返すだけである．これは単に，入力を出力に変換する関数とも考えられるが， できるだけ与えられたデータに適合するように近似することを目標としている点が特徴である．</p>
<p>1ニューロンのニューラルネットは単なる古典的な線形回帰（もしくは分類問題の場合にはロジスティック回帰）である．</p>
<p>以下で用いる用語を整理しておこう．</p>
<ul>
<li>人工知能: 機械に知能を持たせるための技術．</li>
<li>機械学習：（教師ありに限定だが）入力データと出力データから，モデルのパラメータを調整する方法．</li>
<li>ニューラルネット：単なる関数近似器．</li>
<li>深層学習：単なる多次元分散型関数近似器．</li>
<li>fastai：PyTorchのラッパー</li>
</ul>
</section>
<section id="深層学習の歴史" class="level2">
<h2 class="anchored" data-anchor-id="深層学習の歴史">深層学習の歴史</h2>
<p>いま流行の深層学習(deep learning)はニューラルネットから生まれ，そのニューラルネットはパーセプトロンから生まれた．起源であるパーセプトロンまで遡ろう．</p>
<p>1958年に，コーネル大学の心理学者であったFrank Rosenblattがパーセプトロンの概念を提案した．これは1層からなるニューラルネットであり，極めて単純な構成をもつが，当時は部屋いっぱいのパンチカード式の計算機が必要であった．</p>
<p>隠れ層のない2層のニューラルネットでの出力誤差からの確率的勾配降下法は1960年にB. Widrow と M.E. Hoff, Jr.&nbsp;らが Widrow-Hoff 法（デルタルール）という名称で発表した． 隠れ層のある3層以上のニューラルネットは、1967年に甘利俊一が発表した．</p>
<p>1969年に，MITのMarvin Minsky（人工知能の巨人として知られる）が，ニューラルネットの限界についての論文を発表した．彼の名声による影響のためか，その後ニューラルネットの研究は徐々に下火になっていく．</p>
<p>2006年に，トロント大学のGeoffrey Hinton（ニューラルネットの父として知られる）は，多階層のニューラルネットでも効率よく学習できるような方法に関する論文を発表する． この手法はオートエンコーダーと呼ばれ，その後の深層学習の爆発的な研究のもとになったものである．</p>
<p>2011年にマイクロソフト社は，言語認識のためにニューラルネットを使うようになる．その後も言語認識や機械翻訳は，画像認識ととともに，深層学習の応用分野として定着している．</p>
<p>2012年の7月にGoogle社は猫を認識するためのニューラルネットであるGoogle Brainを開始し，8月には言語認識に用いるようになる．同年の10月には，Hintonの2人の学生が，ImageNetコンテストで断トツの成績で1位になる．これをきっかけに，深層学習が様々な応用に使われるようになる．</p>
<p>2015年の12月には，マイクロソフト社のチームが，ImageNetコンテストで人間を超える結果を出し，2016年3月には，AlphaGoが碁の世界チャンピオンでLee Sedolを打ち負かす（ただしこれは深層学習というより強化学習の成果とも言える）．</p>
<p>最近では，拡散モデル(diffusion model)を用いた高精度の画像の生成や， ChatGPT(Generative Pre-trained Transformer)に代表される自己アテンション(self attention)を用いた自然言語処理への応用が進み，技術の民主化が進んでいる．</p>
</section>
<section id="なぜ深層学習がうまくいくようになったのか" class="level2">
<h2 class="anchored" data-anchor-id="なぜ深層学習がうまくいくようになったのか">なぜ深層学習がうまくいくようになったのか？</h2>
<p>データ量の増大に伴い，それをうまく利用できる手法である深層学習が有効になってきている．層の数を増やしても大丈夫なようなアーキテクチャ（モデル）が開発されたことも，重要な要因である．つまり，データと新しいモデルが両輪となって，様々な分野への応用を後押ししているのである．小さなデータしかないときには，ニューラルネットは線形回帰やサポートベクトル機械(SVM)と同じ程度の性能である．しかし，データが大規模になると，ニューラルネットはSVMより高性能になり，小規模なニューラルネットより大規模なニューラルネットの方が良い性能を出すようになる．</p>
<p>さらには，GPUの低価格化によって単純な計算の反復が必要な深層学習が高速に実行できるようになったことも普及を後押ししている．深層学習がうまく動くことが知られるにつれて，研究も加速している．古典的なシグモイド関数からReLU（ならびにその亜種）への移行，ドロップアウト，バッチ正規化など，実際にうまく動くアルゴリズムの開発も重要な要因である．さらに，応用に応じた様々なモデル（アーキテクチャ）が提案され，問題に応じて適切なモデルを使い分けることができるようになってきたのも，理由の1つである．</p>
<p>多くの人材が深層学習の分野に参入したことも重要な要因であるように感じている．ハイパーパラメータの適正化は，最適化における実験的解析と同様に，膨大な系統的な実験と，それを解析するマンパワーが必要となる．データを公開し，開発したソフトウェアをオープンソースにして配布するといったこの分野の風土も研究を加速している．</p>
<p>データやソフトウェアを非公開にする風土をもつ他の研究分野は，深層学習をお手本にする必要があるだろう．特に，日本の企業との共同研究では，データや開発したソフトウェアは非公開にしがちである．深層学習を牽引するコミュニティーのパワーは，そういった秘密主義がないことに起因している．</p>
</section>
<section id="fastaiとは" class="level2">
<h2 class="anchored" data-anchor-id="fastaiとは">fastaiとは</h2>
<p>深層学習のためのパッケージとしては， tensorflow (+Keras), PyTorchなどが有名であるが，ここではfastai https://www.fast.ai を用いる．</p>
<p>fastaiは、最先端の深層学習を実務家が気軽に適用できるようにするためのパッケージである．</p>
<p>開発者が「AIをもう一度uncoolに」を標語にしているように，専門家でなくても（Pythonを知っていれば）ある程度（というか数年前の世界新記録程度）の深層学習を使うことができる．</p>
<p>特徴は以下の通り。</p>
<ul>
<li>コードが短くかける（Kerasよりも短い）．</li>
<li>速い．</li>
<li>最新の工夫が取り入れられている．</li>
<li>PyTorchの足りない部分を補完してくれる．</li>
<li>無料の（広告なしの）講義ビデオがある．</li>
<li>テキストのソースも無料公開されている． https://github.com/fastai/fastbook</li>
</ul>
<!-- fastaiの無料講義については，https://www.fast.ai/ 内のPractical Deep Learning for Coders 参照．　

本のgithubリポ
https://github.com/fastai/fastbook/

ドキュメント（マニュアル）
https://docs.fast.ai/

日本語の解説ビデオ -->
</section>
<section id="fastaiのインストール" class="level2">
<h2 class="anchored" data-anchor-id="fastaiのインストール">fastaiのインストール</h2>
<p>自分のマシンへのfastaiのインストールは本家サイトを参照されたい．</p>
<p>Google Colab上にはすでにインストールされているので，以下の操作だけを行えば良い．</p>
<ul>
<li>上部メニューのランタイム/ランタイプの種類を変更でGPUをオンにする．</li>
</ul>
<p>割り当てられたGPUを，以下のコマンドで確認しておく．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="op">!</span>nvidia<span class="op">-</span>smi</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Tue Aug 23 01:10:22 2022       
+-----------------------------------------------------------------------------+
| NVIDIA-SMI 460.32.03    Driver Version: 460.32.03    CUDA Version: 11.2     |
|-------------------------------+----------------------+----------------------+
| GPU  Name        Persistence-M| Bus-Id        Disp.A | Volatile Uncorr. ECC |
| Fan  Temp  Perf  Pwr:Usage/Cap|         Memory-Usage | GPU-Util  Compute M. |
|                               |                      |               MIG M. |
|===============================+======================+======================|
|   0  Tesla T4            Off  | 00000000:00:04.0 Off |                    0 |
| N/A   65C    P0    31W /  70W |   2084MiB / 15109MiB |      0%      Default |
|                               |                      |                  N/A |
+-------------------------------+----------------------+----------------------+
                                                                               
+-----------------------------------------------------------------------------+
| Processes:                                                                  |
|  GPU   GI   CI        PID   Type   Process name                  GPU Memory |
|        ID   ID                                                   Usage      |
|=============================================================================|
+-----------------------------------------------------------------------------+</code></pre>
</div>
</div>
<p>#hide google driveにアクセスする権限を与える必要があるので，リンクを開いてauthentification codeをコピペする．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">#![ -e /content ] &amp;&amp; pip install -Uqq fastai  # upgrade fastai on colab</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="mnist_sample" class="level2">
<h2 class="anchored" data-anchor-id="mnist_sample">MNIST_SAMPLE</h2>
<p>深層学習における ”Hello World” は、MNISTの手書き文字認識である。ここでは、さらに簡単なMNISTの一部（<span class="math inline">\(３\)</span>と<span class="math inline">\(７\)</span>だけの画像）を認識するためのニューラルネットを作成する。 これは、2値分類問題と呼ばれ、似た例をあげると，与えられた写真に猫が写っているか否か，受け取ったメイルがスパムか否か，などを判定することがあげられる。 2値分類問題は、独立変数（ニューラルネットの入力，特徴ベクトル）に対する従属変数（ターゲット）が <span class="math inline">\(0\)</span>か<span class="math inline">\(1\)</span>の値をとる問題であると言える．</p>
<p>この簡単な例を用いて、fastaiを用いた訓練 (training) のコツを伝授する．</p>
<p>まず、fastaiで準備されているMNIST_SAMPLEのデータを読み込む．</p>
<p>pathはデータを展開するフォルダ（ディレクトリ）名であり、dlsはデータローダーと名付けられた画像用データローダー (ImageDataLoader)のインスタンスである。</p>
<p>データローダーには，様々なファクトリメソッド（インスタンスを生成するためのメソッド）がある．ここでは，フォルダから生成するfrom_folderメソッドを用いる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.MNIST_SAMPLE)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>doc()でドキュメントをみることができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>doc(ImageDataLoaders)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<hr>
<h3 class="anchored">ImageDataLoaders</h3>
<blockquote class="blockquote"><pre><code>ImageDataLoaders(*loaders, path:str|Path='.', device=None)</code></pre></blockquote><p>Basic wrapper around several `DataLoader`s with factory methods for computer vision problems</p>
<p><a href="https://docs.fast.ai/vision.data.html#imagedataloaders" target="_blank" rel="noreferrer noopener">Show in docs</a></p>
</div>
</div>
<p>読み込んだデータの1バッチ分は，データローダーのshow_batchメソッドでみることができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-11-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>畳み込みニューラルネットモデルのインスタンスを生成し，データとあわせて学習器 learn を生成する．メトリクス（評価尺度）はerror_rateを指定しておく．</p>
<p>学習器はresnet34を用い，学習済みのデータを用いた転移学習を行う．</p>
<section id="resnet" class="level3">
<h3 class="anchored" data-anchor-id="resnet">ResNet</h3>
<p>ResNetは残差ブロックとよばれる層の固まりを，何層にも重ねたものである．残差ブロックでは，ブロックへの入力，線形層，ReLU(rectified linear unit; <span class="math inline">\(\max (0,x)\)</span>)，線形層の流れに，入力そのものを加えたものに，ReLUを行うことによって出力を得る． 入力をそのまま最終の活性化関数の前に繋げることによって，必要のないブロックを跳ばして計算することができるようになり，これによって多層のニューラルネットで発生する勾配消失や勾配爆発を避けることが可能になる． 残差ブロックは，畳み込み層の間に「近道（ショートカット）」を入れたものに他ならない．この「近道」を入れることによって，最適化が楽になることが知られている．局所解が減少し， 滑らかな空間（ランドスケープ）での最適化になるのだ．</p>
<p>残差ネットワークの学習器learnを作成してからlearn.summaryをみると、その構造がわかる。 以下で用いるresnet34は34層の大規模な畳み込みニューラルネットである。実行すると、学習済みの重みが読み込まれ，この重みをもとに転移学習を行うことができる．</p>
</section>
<section id="転移学習" class="level3">
<h3 class="anchored" data-anchor-id="転移学習">転移学習</h3>
<p>通常の訓練においては，初期のパラメータ（重み）はランダムに設定される．しかし，ランダムな初期パラメータからの学習は，アーキテクチャが大規模になると膨大な時間がかかることがある．そこで，特定のアーキテクチャに対して，事前に訓練されたパラメータ（重み）を用いることが行われるようになってきた．これが転移学習 (transfer learning) である．</p>
<p>多層の畳み込みニューラルネットで発生を用いて画像の分類をするケースを考えよう．学習が進むにつれて，最初の方の層では線や角などの簡単な形状を抽出するようになり，層が深まるにつれて徐々に複雑な形状を学習するようになる．たとえば，猫のふわふわした毛に反応するニューロンや，猫の目に反応するニューロンが出てくる．最終層の直前では，分類したい物の特徴を抽出するニューロンがある．転移学習では，他の目的のために訓練されたパラメータを用い，判別を行う最終層だけに対して訓練（パラメータの調整）を行う．線や角の判別は共通であるが，最終的な分類は，対象とするものに依存して再訓練をしなければならないからだ．</p>
<p>最終層のパラメータが十分に訓練されたら，上層のパラメータに対しても訓練を行う方が良い．fine_tuneメソッドは，これを自動的にしてくれる．</p>
</section>
<section id="学習率の調整" class="level3">
<h3 class="anchored" data-anchor-id="学習率の調整">学習率の調整</h3>
<p>深層学習で最も重要なパラメータは，学習率(learning rate: lrと略される）である．深層学習では，重み（パラメータ）調整のために非線形最適化を行う．</p>
<p>つまり，勾配に適当なステップサイズを乗じて現在の値から減じる操作を繰り返す．この非線形最適化におけるステップサイズのことを，学習率と呼んでいる．</p>
<p>これをチューニングするために，fastaiでは学習器オブジェクトにlr_find() というメソッドを準備している．</p>
<p>評価尺度(metrics）に誤差率を指定した学習器learnを作成してlearn.lr_find()とする．</p>
<p>lr_findは，学習率を小さな値から1反復ごとに2倍にしたときの損出関数（目的関数のこと）をプロットしてくれる． 目安だが，最小値をもつ谷に入るあたりの学習率が良いと言われている．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls,resnet34, metrics<span class="op">=</span>error_rate, cbs<span class="op">=</span>ShowGraphCallback())</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/Users/mikiokubo/Library/Caches/pypoetry/virtualenvs/analytics2-0ZiTWol9-py3.9/lib/python3.9/site-packages/torchvision/models/_utils.py:208: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and may be removed in the future, please use 'weights' instead.
  warnings.warn(
/Users/mikiokubo/Library/Caches/pypoetry/virtualenvs/analytics2-0ZiTWol9-py3.9/lib/python3.9/site-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and may be removed in the future. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)
Downloading: "https://download.pytorch.org/models/resnet34-b627a593.pth" to /Users/mikiokubo/.cache/torch/hub/checkpoints/resnet34-b627a593.pth
100%|███████████████████████████████████████████████████████████████████| 83.3M/83.3M [00:02&lt;00:00, 40.8MB/s]</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.0020892962347716093)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-12-output-5.png" class="img-fluid"></p>
</div>
</div>
<p>損出関数が最小になるのは，学習率が0.2あたりだが，最も大きな谷の下り坂に入るあたりが良いとされている．ここでは，学習率を1e-2 (0.01)に設定して訓練してみる．</p>
<p>これには学習器インスタンスのfit_tuneメソッドを用いる．引数はエポック数（最適化の反復回数；データ全体を何回使うかを表す）と学習率である．</p>
<p>なお，実際の反復ごとの学習率は，学習器のcbs引数をShowGraphCallback()とすると，見ることができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>doc(learn.fine_tune)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Learner.fine_tune(epochs, base_lr=0.002, freeze_epochs=1, lr_mult=100, pct_start=0.3, div=5.0, *, lr_max=None, div_final=100000.0, wd=None, moms=None, cbs=None, reset_opt=False, start_epoch=0)
Fine tune with `Learner.freeze` for `freeze_epochs`, then with `Learner.unfreeze` for `epochs`, using discriminative LR.

To get a prettier result with hyperlinks to source code and documentation, install nbdev: pip install nbdev</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">2</span>, base_lr<span class="op">=</span><span class="fl">0.01</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.200721</td>
<td>0.140300</td>
<td>0.038273</td>
<td>00:14</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-14-output-3.png" class="img-fluid"></p>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.034825</td>
<td>0.004138</td>
<td>0.001472</td>
<td>00:24</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.005775</td>
<td>0.003441</td>
<td>0.000981</td>
<td>00:21</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-14-output-6.png" class="img-fluid"></p>
</div>
</div>
<p>評価尺度の誤差率は非常に小さく、図から訓練はうまく行われているようだ。 結果を表示してみる。大体当たっているようだ。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-15-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>fine_tuneでは、最終層以外を固定して（既定値では１回）訓練を行い、その後、fit_one_cycleを用いて、指定したエポック数だけ訓練する。 fit_one_cycleは，学習率を小さな値から最大学習率まで増やし，その後徐々に減少させていく．同時に，慣性項を徐々に下げて，その後増加させていく最適化法で，これを使うと収束が速くなると言われている．</p>
<p>fine_tuneメソッドの引数はエポック数と基本学習率 base_lr である．</p>
<p>分類モデルの結果を解釈は、ClassificationInterpretation()クラスのfrom_learnerメソッドを用いてできる。 plot_top_lossesを用いると，損出関数が悪かったデータを描画してくれる． 引数は画像数と画像のサイズである．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> ClassificationInterpretation.from_learner(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">7</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-17-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>正解と外れを表す表（混同行列とよばれる）を出力するには，plot_confusion_matrixを使う．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>interp.plot_confusion_matrix()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-18-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="cifar10" class="level2">
<h2 class="anchored" data-anchor-id="cifar10">Cifar10</h2>
<p>Cifar10は粗い画像から，10種類の物体を当てるデータセットである．</p>
<p>ImageDataLoaderのfrom_forder()メソッドでデータローダーを生成する． 検証（テスト）データは10%に設定する．</p>
<!-- データを読み込んだ後に，get_ransform()で **データ増大**(data augmentation)を行うためのオブジェクトtfms を生成する．
その際に引数df_tfmsにtfmsを渡して訓練時に画像を多少変えて行うように設定する．
最後に，データ束をnormalize()メソッドで正規化して表示する． -->
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.CIFAR)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="168173568" class="" max="168168549" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.00% [168173568/168168549 00:01&lt;00:00]
    </div>
    
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_folder(path,valid_pct<span class="op">=</span><span class="fl">0.1</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-20-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet50, metrics<span class="op">=</span>[error_rate,accuracy])</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>lr<span class="op">=</span> learn.lr_find() </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(lr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/fastai/vision/learner.py:284: UserWarning: `cnn_learner` has been renamed to `vision_learner` -- please update your code
  warn("`cnn_learner` has been renamed to `vision_learner` -- please update your code")
/usr/local/lib/python3.7/dist-packages/torchvision/models/_utils.py:209: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  f"The parameter '{pretrained_param}' is deprecated since 0.13 and will be removed in 0.15, "
/usr/local/lib/python3.7/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet50_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet50_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)
Downloading: "https://download.pytorch.org/models/resnet50-0676ba61.pth" to /root/.cache/torch/hub/checkpoints/resnet50-0676ba61.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"1896fa3a73534c14b967215ac2311447","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>SuggestedLRs(valley=0.001737800776027143)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-21-output-6.png" class="img-fluid"></p>
</div>
</div>
<p>データとアーキテクチャ（モデル：RESNET）をあわせて学習器を生成する．</p>
<p>メトリクスは正解率(accuracy)とする．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">10</span>, base_lr<span class="op">=</span><span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.720446</td>
<td>1.487195</td>
<td>0.504833</td>
<td>0.495167</td>
<td>01:36</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="1" class="" max="10" style="width:300px; height:20px; vertical-align: middle;"></progress>
      10.00% [1/10 01:36&lt;14:28]
    </div>
    

<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.095862</td>
<td>0.945130</td>
<td>0.328167</td>
<td>0.671833</td>
<td>01:36</td>
</tr>
</tbody>
</table>
<p>

    </p><div>
      <progress value="475" class="" max="843" style="width:300px; height:20px; vertical-align: middle;"></progress>
      56.35% [475/843 00:49&lt;00:38 0.8759]
    </div>
    
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>1.095862</td>
<td>0.945130</td>
<td>0.328167</td>
<td>0.671833</td>
<td>01:36</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.819684</td>
<td>0.715804</td>
<td>0.244000</td>
<td>0.756000</td>
<td>01:33</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.614426</td>
<td>0.609761</td>
<td>0.205833</td>
<td>0.794167</td>
<td>01:33</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.429096</td>
<td>0.574650</td>
<td>0.193333</td>
<td>0.806667</td>
<td>01:34</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.293377</td>
<td>0.609565</td>
<td>0.186167</td>
<td>0.813833</td>
<td>01:34</td>
</tr>
<tr class="even">
<td>5</td>
<td>0.157066</td>
<td>0.681249</td>
<td>0.180667</td>
<td>0.819333</td>
<td>01:34</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.088063</td>
<td>0.761130</td>
<td>0.183500</td>
<td>0.816500</td>
<td>01:34</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.047697</td>
<td>0.804281</td>
<td>0.181500</td>
<td>0.818500</td>
<td>01:34</td>
</tr>
<tr class="odd">
<td>8</td>
<td>0.023899</td>
<td>0.817061</td>
<td>0.181333</td>
<td>0.818667</td>
<td>01:34</td>
</tr>
<tr class="even">
<td>9</td>
<td>0.026840</td>
<td>0.833239</td>
<td>0.180333</td>
<td>0.819667</td>
<td>01:33</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>損出関数の大きい順に5つのデータを出力する．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> Interpretation.from_learner(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-24-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="pets" class="level2">
<h2 class="anchored" data-anchor-id="pets">PETS</h2>
<p>画像ファイルから犬か猫かを判別する．</p>
<p>モデル（アーキテキクチャ）は画像ファイルなのでResNetを用いる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PETS)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>path.ls()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#2) [Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/images'),Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/annotations')]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>path_anno <span class="op">=</span> path<span class="op">/</span><span class="st">"annotations"</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>path_img <span class="op">=</span> path<span class="op">/</span><span class="st">"images"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>fnames <span class="op">=</span> get_image_files(path_img)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>fnames[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>(#5) [Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/images/Egyptian_Mau_167.jpg'),Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/images/pug_52.jpg'),Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/images/basset_hound_112.jpg'),Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/images/Siamese_193.jpg'),Path('/Users/mikiokubo/.fastai/data/oxford-iiit-pet/images/shiba_inu_122.jpg')]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>files <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">"images"</span>)</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">len</span>(files)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>7390</code></pre>
</div>
</div>
<p>犬か猫かはファイル名の最初の文字が大文字か小文字かで判別できる．</p>
<p>ImageDataLoadersクラスのfrom_name_func()メソッドを用いてデータローダーを生成する．</p>
<p>引数は順に，</p>
<ul>
<li>データセットのパス path</li>
<li>ファイル名のリスト files</li>
<li>ラベル名を判定する関数 label_func</li>
<li>データ変換（ここでは画像ファイルのサイズの変更） item_tfms</li>
</ul>
<p>である．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> label_func(f): <span class="cf">return</span> f[<span class="dv">0</span>].isupper() <span class="co">#犬猫の判定</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_name_func(path, files, label_func, item_tfms<span class="op">=</span>Resize(<span class="dv">224</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-32-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>error_rate)</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/fastai/vision/learner.py:284: UserWarning: `cnn_learner` has been renamed to `vision_learner` -- please update your code
  warn("`cnn_learner` has been renamed to `vision_learner` -- please update your code")
/usr/local/lib/python3.7/dist-packages/torchvision/models/_utils.py:209: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  f"The parameter '{pretrained_param}' is deprecated since 0.13 and will be removed in 0.15, "
/usr/local/lib/python3.7/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)</code></pre>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.156178</td>
<td>0.016154</td>
<td>0.004060</td>
<td>00:52</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.054338</td>
<td>0.005073</td>
<td>0.001353</td>
<td>00:54</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-34-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>今度は，同じデータセットを用いて，<span class="math inline">\(37\)</span>種類のPETの種類を判別する．</p>
<p>データの読み込みには正規表現を用いる．</p>
<p>ImageDataLoaderクラスのfrom_name_re()メソッドは，正規表現を用いてデータを生成する．</p>
<p>引数は順に，</p>
<ul>
<li>データセットのパス path</li>
<li>ファイル名のリスト files</li>
<li>クラス名をファイル名から抽出するための正規表現 pat</li>
<li>データ変換（ここでは画像ファイルのサイズの変更） item_tfms</li>
<li>aug_transformsによるデータ増大 batch_tfms</li>
</ul>
<p>である．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>pat <span class="op">=</span> <span class="vs">r"^(.*)_\d+.jpg"</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> ImageDataLoaders.from_name_re(path, files, pat, item_tfms<span class="op">=</span>Resize(<span class="dv">460</span>),</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>                                    batch_tfms<span class="op">=</span>aug_transforms(size<span class="op">=</span><span class="dv">224</span>))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-35-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet34, metrics<span class="op">=</span>error_rate)</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(valley=0.0010000000474974513)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-36-output-4.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">4</span>, <span class="fl">0.001</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.070160</td>
<td>0.406866</td>
<td>0.123139</td>
<td>01:07</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">error_rate</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.576859</td>
<td>0.279217</td>
<td>0.085250</td>
<td>01:10</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.409450</td>
<td>0.238351</td>
<td>0.067659</td>
<td>01:10</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.260191</td>
<td>0.211842</td>
<td>0.070365</td>
<td>01:10</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.193102</td>
<td>0.204086</td>
<td>0.064953</td>
<td>01:10</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-38-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>interp <span class="op">=</span> Interpretation.from_learner(learn)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>interp.plot_top_losses(<span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">15</span>,<span class="dv">10</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-40-output-3.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="表形式データ" class="level2">
<h2 class="anchored" data-anchor-id="表形式データ">表形式データ</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="例題-サラリーの分類" class="level3">
<h3 class="anchored" data-anchor-id="例題-サラリーの分類">例題： サラリーの分類</h3>
<p>ADULT_SAMPLEは，小規模な表形式データであり，$50k以上の収入があるかどうかを当てるのが目的だ．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.ADULT_SAMPLE)</span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

    <div>
      <progress value="974848" class="" max="968212" style="width:300px; height:20px; vertical-align: middle;"></progress>
      100.69% [974848/968212 00:00&lt;00:00]
    </div>
    
</div>
<div class="cell-output cell-output-display">
<pre><code>Path('/Users/mikiokubo/.fastai/data/adult_sample')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path <span class="op">/</span> <span class="st">"adult.csv"</span>)</span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>df.head().T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
<th data-quarto-table-cell-role="th">1</th>
<th data-quarto-table-cell-role="th">2</th>
<th data-quarto-table-cell-role="th">3</th>
<th data-quarto-table-cell-role="th">4</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">age</td>
<td>49</td>
<td>44</td>
<td>38</td>
<td>38</td>
<td>42</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">workclass</td>
<td>Private</td>
<td>Private</td>
<td>Private</td>
<td>Self-emp-inc</td>
<td>Self-emp-not-inc</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">fnlwgt</td>
<td>101320</td>
<td>236746</td>
<td>96185</td>
<td>112847</td>
<td>82297</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">education</td>
<td>Assoc-acdm</td>
<td>Masters</td>
<td>HS-grad</td>
<td>Prof-school</td>
<td>7th-8th</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">education-num</td>
<td>12.0</td>
<td>14.0</td>
<td>NaN</td>
<td>15.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">marital-status</td>
<td>Married-civ-spouse</td>
<td>Divorced</td>
<td>Divorced</td>
<td>Married-civ-spouse</td>
<td>Married-civ-spouse</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">occupation</td>
<td>NaN</td>
<td>Exec-managerial</td>
<td>NaN</td>
<td>Prof-specialty</td>
<td>Other-service</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">relationship</td>
<td>Wife</td>
<td>Not-in-family</td>
<td>Unmarried</td>
<td>Husband</td>
<td>Wife</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">race</td>
<td>White</td>
<td>White</td>
<td>Black</td>
<td>Asian-Pac-Islander</td>
<td>Black</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">sex</td>
<td>Female</td>
<td>Male</td>
<td>Female</td>
<td>Male</td>
<td>Female</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">capital-gain</td>
<td>0</td>
<td>10520</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">capital-loss</td>
<td>1902</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">hours-per-week</td>
<td>40</td>
<td>45</td>
<td>32</td>
<td>40</td>
<td>50</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">native-country</td>
<td>United-States</td>
<td>United-States</td>
<td>United-States</td>
<td>United-States</td>
<td>United-States</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">salary</td>
<td>&gt;=50k</td>
<td>&gt;=50k</td>
<td>&lt;50k</td>
<td>&gt;=50k</td>
<td>&lt;50k</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>表形式データの基本クラスは TabularDataLoaders であり，これはfrom_csvメソッドやfrom_dfを用いて作ることができる．</p>
<p>from_csvの主な引数の意味は以下の通り．</p>
<ul>
<li><p>csv: csvファイル</p></li>
<li><p>path: ファイルの置き場所</p></li>
<li><p>y_names: 従属変数（ターゲット）の列名（のリスト）</p></li>
<li><p>valid_idx: 検証用データのインデックス</p></li>
<li><p>proc: 前処理の方法を入れたリスト</p></li>
<li><p>cat_names: カテゴリーデータの列名のリスト</p></li>
<li><p>cont_names: 連続量データの列名のリスト</p></li>
<li><p>カテゴリーデータと連続量データを自動的に分けてくれる以下の関数も準備されている．</p></li>
</ul>
<pre><code>cont_names, cat_names = cont_cat_split(df=データフレーム, dep_var=従属変数の列名)</code></pre>
<ul>
<li>procs: 前処理の指定</li>
</ul>
<p>前処理には以下のものがある．</p>
<ul>
<li><p>Categorify: cat_names引数で与えた列リストをカテゴリー変数とする．</p></li>
<li><p>FillMissing： cont_namesに含まれる連続変数に対して欠損値処理を行う．</p></li>
</ul>
<p>引数の<code>FillStrategy</code>には[MEDIAN, COMMON, CONSTANT]があり，順にメディアン，最頻値，定数（fill_valで指定）である． また，add_col引数がTrueのときには，欠損値であることを表す列を追加する．</p>
<ul>
<li>Normalize: cont_namesに含まれる連続変数の正規化を行う．(平均を引いて標準偏差+微少量で割る．）</li>
</ul>
<p>時刻型の列を自動的に幾つかの変数に変換する以下の関数が準備されている．</p>
<pre><code>add_datepart(df, fldname, drop=True, time=False)</code></pre>
<p>fldnameは時刻型が含まれている列名であり，dropがTrueのとき元の列を削除する．またtimeがTrueのときには，日付だけでなく時，分，秒の列も追加する．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> TabularDataLoaders.from_csv(</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>    path <span class="op">/</span> <span class="st">"adult.csv"</span>,</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>    path<span class="op">=</span>path,</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>    y_names<span class="op">=</span><span class="st">"salary"</span>,</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    cat_names<span class="op">=</span>[</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">"workclass"</span>,</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"education"</span>,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"marital-status"</span>,</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"occupation"</span>,</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"relationship"</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>        <span class="st">"race"</span>,</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>    cont_names<span class="op">=</span>[<span class="st">"age"</span>, <span class="st">"fnlwgt"</span>, <span class="st">"education-num"</span>],</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>    procs<span class="op">=</span>[Categorify, FillMissing, Normalize],</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">workclass</th>
<th data-quarto-table-cell-role="th">education</th>
<th data-quarto-table-cell-role="th">marital-status</th>
<th data-quarto-table-cell-role="th">occupation</th>
<th data-quarto-table-cell-role="th">relationship</th>
<th data-quarto-table-cell-role="th">race</th>
<th data-quarto-table-cell-role="th">education-num_na</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">fnlwgt</th>
<th data-quarto-table-cell-role="th">education-num</th>
<th data-quarto-table-cell-role="th">salary</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Private</td>
<td>Bachelors</td>
<td>Married-civ-spouse</td>
<td>Sales</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>45.000000</td>
<td>162186.999591</td>
<td>13.0</td>
<td>&gt;=50k</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Private</td>
<td>Some-college</td>
<td>Married-civ-spouse</td>
<td>Tech-support</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>50.000000</td>
<td>226496.999148</td>
<td>10.0</td>
<td>&gt;=50k</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Self-emp-inc</td>
<td>Bachelors</td>
<td>Married-civ-spouse</td>
<td>Exec-managerial</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>49.000000</td>
<td>197038.000301</td>
<td>13.0</td>
<td>&gt;=50k</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Private</td>
<td>HS-grad</td>
<td>Married-civ-spouse</td>
<td>Farming-fishing</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>35.000000</td>
<td>54317.004480</td>
<td>9.0</td>
<td>&lt;50k</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Private</td>
<td>HS-grad</td>
<td>Married-civ-spouse</td>
<td>Machine-op-inspct</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>45.000000</td>
<td>197730.999852</td>
<td>9.0</td>
<td>&lt;50k</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Private</td>
<td>1st-4th</td>
<td>Never-married</td>
<td>#na#</td>
<td>Not-in-family</td>
<td>White</td>
<td>True</td>
<td>22.000000</td>
<td>464102.988691</td>
<td>10.0</td>
<td>&lt;50k</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Private</td>
<td>Bachelors</td>
<td>Married-civ-spouse</td>
<td>Prof-specialty</td>
<td>Wife</td>
<td>Black</td>
<td>False</td>
<td>28.000000</td>
<td>338408.999201</td>
<td>13.0</td>
<td>&lt;50k</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Private</td>
<td>Some-college</td>
<td>Married-civ-spouse</td>
<td>Prof-specialty</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>57.000001</td>
<td>171242.000203</td>
<td>10.0</td>
<td>&gt;=50k</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>State-gov</td>
<td>HS-grad</td>
<td>Married-civ-spouse</td>
<td>Other-service</td>
<td>Wife</td>
<td>White</td>
<td>False</td>
<td>30.000000</td>
<td>234823.998613</td>
<td>9.0</td>
<td>&lt;50k</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Self-emp-not-inc</td>
<td>HS-grad</td>
<td>Married-civ-spouse</td>
<td>Sales</td>
<td>Husband</td>
<td>White</td>
<td>False</td>
<td>55.000000</td>
<td>184701.999856</td>
<td>9.0</td>
<td>&lt;50k</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a>cont_names, cat_names <span class="op">=</span> cont_cat_split(df, max_card<span class="op">=</span><span class="dv">50</span>, dep_var<span class="op">=</span><span class="st">"salary"</span>)</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>cat_names</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>['workclass',
 'education',
 'marital-status',
 'occupation',
 'relationship',
 'race',
 'sex',
 'native-country']</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [FillMissing, Categorify, Normalize]  <span class="co"># 前処理の種類を準備．</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>valid_idx <span class="op">=</span> <span class="bu">range</span>(<span class="bu">len</span>(df) <span class="op">-</span> <span class="dv">2000</span>, <span class="bu">len</span>(df))  <span class="co"># 検証用データのインデックスを準備．</span></span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>dep_var <span class="op">=</span> <span class="st">"salary"</span>  <span class="co"># 従属変数名とカテゴリー変数が格納されている列リストを準備．</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>cat_names <span class="op">=</span> [</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"workclass"</span>,</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"education"</span>,</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">"marital-status"</span>,</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">"occupation"</span>,</span>
<span id="cb59-9"><a href="#cb59-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">"relationship"</span>,</span>
<span id="cb59-10"><a href="#cb59-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race"</span>,</span>
<span id="cb59-11"><a href="#cb59-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">"sex"</span>,</span>
<span id="cb59-12"><a href="#cb59-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">"native-country"</span>,</span>
<span id="cb59-13"><a href="#cb59-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb59-14"><a href="#cb59-14" aria-hidden="true" tabindex="-1"></a>cont_names <span class="op">=</span> [</span>
<span id="cb59-15"><a href="#cb59-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">"age"</span>,</span>
<span id="cb59-16"><a href="#cb59-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">"fnlwgt"</span>,</span>
<span id="cb59-17"><a href="#cb59-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">"education-num"</span>,</span>
<span id="cb59-18"><a href="#cb59-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">"capital-gain"</span>,</span>
<span id="cb59-19"><a href="#cb59-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">"capital-loss"</span>,</span>
<span id="cb59-20"><a href="#cb59-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">"hours-per-week"</span>,</span>
<span id="cb59-21"><a href="#cb59-21" aria-hidden="true" tabindex="-1"></a>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>tabular_learner関数で表形式データの深層学習器を作ることができる．</p>
<p>主な引数の意味は以下の通り． - dls: データローダー - layers: レイヤの数を指定したリスト - emb_szs: カテゴリーデータの列名をキー，埋め込みサイズを値とした辞書 - metrics: 評価尺度(accuracyなど） - emb_drop: 埋め込みレイヤのdrop out率</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 深層学習(PyTorch)の学習器インスタンスlearnを生成し，fitメソッドで訓練．引数はエポック数と学習率．</span></span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, metrics<span class="op">=</span>accuracy)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">3</span>, <span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.378957</td>
<td>0.361153</td>
<td>0.829853</td>
<td>00:03</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.355874</td>
<td>0.355134</td>
<td>0.835995</td>
<td>00:03</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.352343</td>
<td>0.352415</td>
<td>0.835688</td>
<td>00:03</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>summary属性をみると，学習器は，埋め込み層に続いて2つの線形層を配置したニューラルネットになっていることが確認できる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>learn.summary()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>TabularModel (Input shape: 64 x 7)
============================================================================
Layer (type)         Output Shape         Param #    Trainable 
============================================================================
                     64 x 6              
Embedding                                 60         True      
____________________________________________________________________________
                     64 x 8              
Embedding                                 136        True      
____________________________________________________________________________
                     64 x 5              
Embedding                                 40         True      
____________________________________________________________________________
                     64 x 8              
Embedding                                 128        True      
____________________________________________________________________________
                     64 x 5              
Embedding                                 35         True      
____________________________________________________________________________
                     64 x 4              
Embedding                                 24         True      
____________________________________________________________________________
                     64 x 3              
Embedding                                 9          True      
Dropout                                                        
BatchNorm1d                               6          True      
____________________________________________________________________________
                     64 x 200            
Linear                                    8400       True      
ReLU                                                           
BatchNorm1d                               400        True      
____________________________________________________________________________
                     64 x 100            
Linear                                    20000      True      
ReLU                                                           
BatchNorm1d                               200        True      
____________________________________________________________________________
                     64 x 2              
Linear                                    202        True      
____________________________________________________________________________

Total params: 29,640
Total trainable params: 29,640
Total non-trainable params: 0

Optimizer used: &lt;function Adam&gt;
Loss function: FlattenedLoss of CrossEntropyLoss()

Model unfrozen

Callbacks:
  - TrainEvalCallback
  - CastToTensor
  - Recorder
  - ProgressCallback</code></pre>
</div>
</div>
</section>
<section id="例題住宅価格の予測" class="level3">
<h3 class="anchored" data-anchor-id="例題住宅価格の予測">例題：住宅価格の予測</h3>
<p>Bostonの住宅価格の予測を深層学習を用いた回帰分析で行う．</p>
<p>medvが住宅の価格で，他のデータ（犯罪率や人口などの数値データ）から予測する．</p>
<p>ただし，訓練データとテストデータのインデックス（<strong>train_idx</strong>,<strong>valid_idx</strong>）を生成するには， 以下に示すように，scikit-learnの<strong>train_test_split</strong>を用いる．</p>
<p>連続データとカテゴリーデータの列は， <strong>cont_cat_split</strong>関数を用いる． 引数の <strong>max_card</strong> <span class="math inline">\(=50\)</span> は <span class="math inline">\(50\)</span>以下の種類しかもたない列はカテゴリー変数とみなすことを意味する． また，引数の <strong>dep_var</strong>は従属変数名である．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>boston <span class="op">=</span> pd.read_csv(<span class="st">"http://logopt.com/data/Boston.csv"</span>,index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb65-2"><a href="#cb65-2" aria-hidden="true" tabindex="-1"></a>procs <span class="op">=</span> [Categorify, FillMissing, Normalize] <span class="co">#前処理の種類を準備．</span></span>
<span id="cb65-3"><a href="#cb65-3" aria-hidden="true" tabindex="-1"></a>train_idx, valid_idx <span class="op">=</span> train_test_split(<span class="bu">range</span>(<span class="bu">len</span>(boston)), test_size<span class="op">=</span><span class="fl">0.3</span>) <span class="co">#検証用データのインデックスを準備．</span></span>
<span id="cb65-4"><a href="#cb65-4" aria-hidden="true" tabindex="-1"></a>dep_var <span class="op">=</span> <span class="st">"medv"</span> <span class="co">#従属変数名を準備．</span></span>
<span id="cb65-5"><a href="#cb65-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb65-6"><a href="#cb65-6" aria-hidden="true" tabindex="-1"></a>cont_names, cat_names <span class="op">=</span> cont_cat_split(boston, max_card <span class="op">=</span> <span class="dv">50</span>, dep_var<span class="op">=</span>dep_var)</span>
<span id="cb65-7"><a href="#cb65-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(cat_names, cont_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>['chas', 'rad'] ['crim', 'zn', 'indus', 'nox', 'rm', 'age', 'dis', 'tax', 'ptratio', 'black', 'lstat']</code></pre>
</div>
</div>
<p>準備ができたので， <strong>TabularDataLoaders</strong>の<strong>from_df</strong>メソッドでデータローダーを生成し，それをもとに<strong>tabular_learner</strong>関数で学習器 learn を作る． 評価尺度(metrics)には <strong>rmse</strong> （rooted mean square error)を用いる．</p>
<p>fit_one_cycle法を用いて， 30エポック，最大学習率0.001で訓練する．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> TabularDataLoaders.from_df(boston, y_names<span class="op">=</span>dep_var, procs <span class="op">=</span> procs, cont_names<span class="op">=</span>cont_names, cat_names<span class="op">=</span>cat_names)</span>
<span id="cb67-2"><a href="#cb67-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> tabular_learner(dls, metrics<span class="op">=</span>rmse)</span>
<span id="cb67-3"><a href="#cb67-3" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">30</span>,<span class="fl">1e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">_rmse</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>583.483521</td>
<td>612.155334</td>
<td>24.741774</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>1</td>
<td>581.810120</td>
<td>611.932373</td>
<td>24.737268</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>2</td>
<td>578.824707</td>
<td>608.098999</td>
<td>24.659664</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>3</td>
<td>574.245300</td>
<td>598.170288</td>
<td>24.457520</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>4</td>
<td>567.828918</td>
<td>579.099182</td>
<td>24.064480</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>5</td>
<td>556.611816</td>
<td>545.330933</td>
<td>23.352322</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>6</td>
<td>537.237671</td>
<td>484.291077</td>
<td>22.006615</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>7</td>
<td>508.969635</td>
<td>396.657959</td>
<td>19.916273</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>8</td>
<td>469.514343</td>
<td>293.581970</td>
<td>17.134233</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>9</td>
<td>424.950714</td>
<td>204.514008</td>
<td>14.300838</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>10</td>
<td>377.579315</td>
<td>132.951584</td>
<td>11.530462</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>11</td>
<td>334.218781</td>
<td>91.368095</td>
<td>9.558666</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>12</td>
<td>295.503296</td>
<td>62.303730</td>
<td>7.893271</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>13</td>
<td>261.120300</td>
<td>45.621571</td>
<td>6.754374</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>14</td>
<td>231.821823</td>
<td>36.233948</td>
<td>6.019464</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>15</td>
<td>205.355896</td>
<td>31.576481</td>
<td>5.619295</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>16</td>
<td>182.979019</td>
<td>28.494129</td>
<td>5.337989</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>17</td>
<td>163.683594</td>
<td>26.984529</td>
<td>5.194664</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>18</td>
<td>146.885498</td>
<td>25.802696</td>
<td>5.079636</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>19</td>
<td>132.069229</td>
<td>23.790033</td>
<td>4.877503</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>20</td>
<td>119.163567</td>
<td>23.443287</td>
<td>4.841827</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>21</td>
<td>107.618279</td>
<td>22.275869</td>
<td>4.719732</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>22</td>
<td>97.619194</td>
<td>21.489685</td>
<td>4.635697</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>23</td>
<td>88.492821</td>
<td>20.707258</td>
<td>4.550523</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>24</td>
<td>80.453087</td>
<td>20.948822</td>
<td>4.576989</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>25</td>
<td>73.967003</td>
<td>20.161036</td>
<td>4.490104</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>26</td>
<td>68.017082</td>
<td>20.298531</td>
<td>4.505389</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>27</td>
<td>62.846817</td>
<td>20.439318</td>
<td>4.520987</td>
<td>00:00</td>
</tr>
<tr class="odd">
<td>28</td>
<td>58.536152</td>
<td>20.634672</td>
<td>4.542541</td>
<td>00:00</td>
</tr>
<tr class="even">
<td>29</td>
<td>53.941723</td>
<td>20.251295</td>
<td>4.500144</td>
<td>00:00</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="問題スパム" class="level3">
<h3 class="anchored" data-anchor-id="問題スパム">問題（スパム）</h3>
<p>メールがスパム（spam；迷惑メイル）か否かを，深層学習を用いて判定せよ．</p>
<p>データは，様々な数値情報から，<strong>is_spam</strong>列が1 （スパム）か，0（スパムでない）かを判定するデータである．</p>
<p>評価尺度はaccuracyとする．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>spam <span class="op">=</span> pd.read_csv(<span class="st">"http://logopt.com/data/spam.csv"</span>)</span>
<span id="cb68-2"><a href="#cb68-2" aria-hidden="true" tabindex="-1"></a>spam.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">word_freq_make</th>
<th data-quarto-table-cell-role="th">word_freq_address</th>
<th data-quarto-table-cell-role="th">word_freq_all</th>
<th data-quarto-table-cell-role="th">word_freq_3d</th>
<th data-quarto-table-cell-role="th">word_freq_our</th>
<th data-quarto-table-cell-role="th">word_freq_over</th>
<th data-quarto-table-cell-role="th">word_freq_remove</th>
<th data-quarto-table-cell-role="th">word_freq_internet</th>
<th data-quarto-table-cell-role="th">word_freq_order</th>
<th data-quarto-table-cell-role="th">word_freq_mail</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">char_freq_;</th>
<th data-quarto-table-cell-role="th">char_freq_(</th>
<th data-quarto-table-cell-role="th">char_freq_[</th>
<th data-quarto-table-cell-role="th">char_freq_!</th>
<th data-quarto-table-cell-role="th">char_freq_$</th>
<th data-quarto-table-cell-role="th">char_freq_#</th>
<th data-quarto-table-cell-role="th">capital_run_length_average</th>
<th data-quarto-table-cell-role="th">capital_run_length_longest</th>
<th data-quarto-table-cell-role="th">capital_run_length_total</th>
<th data-quarto-table-cell-role="th">is_spam</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.21</td>
<td>0.28</td>
<td>0.50</td>
<td>0.0</td>
<td>0.14</td>
<td>0.28</td>
<td>0.21</td>
<td>0.07</td>
<td>0.00</td>
<td>0.94</td>
<td>...</td>
<td>0.00</td>
<td>0.132</td>
<td>0.0</td>
<td>0.372</td>
<td>0.180</td>
<td>0.048</td>
<td>5.114</td>
<td>101</td>
<td>1028</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.06</td>
<td>0.00</td>
<td>0.71</td>
<td>0.0</td>
<td>1.23</td>
<td>0.19</td>
<td>0.19</td>
<td>0.12</td>
<td>0.64</td>
<td>0.25</td>
<td>...</td>
<td>0.01</td>
<td>0.143</td>
<td>0.0</td>
<td>0.276</td>
<td>0.184</td>
<td>0.010</td>
<td>9.821</td>
<td>485</td>
<td>2259</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.0</td>
<td>0.63</td>
<td>0.00</td>
<td>0.31</td>
<td>0.63</td>
<td>0.31</td>
<td>0.63</td>
<td>...</td>
<td>0.00</td>
<td>0.137</td>
<td>0.0</td>
<td>0.137</td>
<td>0.000</td>
<td>0.000</td>
<td>3.537</td>
<td>40</td>
<td>191</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.0</td>
<td>0.63</td>
<td>0.00</td>
<td>0.31</td>
<td>0.63</td>
<td>0.31</td>
<td>0.63</td>
<td>...</td>
<td>0.00</td>
<td>0.135</td>
<td>0.0</td>
<td>0.135</td>
<td>0.000</td>
<td>0.000</td>
<td>3.537</td>
<td>40</td>
<td>191</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.00</td>
<td>0.00</td>
<td>0.00</td>
<td>0.0</td>
<td>1.85</td>
<td>0.00</td>
<td>0.00</td>
<td>1.85</td>
<td>0.00</td>
<td>0.00</td>
<td>...</td>
<td>0.00</td>
<td>0.223</td>
<td>0.0</td>
<td>0.000</td>
<td>0.000</td>
<td>0.000</td>
<td>3.000</td>
<td>15</td>
<td>54</td>
<td>1</td>
</tr>
</tbody>
</table>

<p>5 rows × 58 columns</p>
</div>
</div>
</div>
</section>
<section id="問題毒キノコ" class="level3">
<h3 class="anchored" data-anchor-id="問題毒キノコ">問題（毒キノコ）</h3>
<p>データから毒キノコか否かを，深層学習を用いて判定せよ．</p>
<p><strong>target</strong>列がターゲット（従属変数）であり，<strong>edible</strong>が食用，<strong>poisonous</strong>が毒である．</p>
<p>評価尺度はaccuracyとする．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1" aria-hidden="true" tabindex="-1"></a>mashroom <span class="op">=</span> pd.read_csv(</span>
<span id="cb69-2"><a href="#cb69-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"http://logopt.com/data/mashroom.csv"</span>,</span>
<span id="cb69-3"><a href="#cb69-3" aria-hidden="true" tabindex="-1"></a>    dtype<span class="op">=</span>{<span class="st">"shape"</span>: <span class="st">"category"</span>, <span class="st">"surface"</span>: <span class="st">"category"</span>, <span class="st">"color"</span>: <span class="st">"category"</span>},</span>
<span id="cb69-4"><a href="#cb69-4" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb69-5"><a href="#cb69-5" aria-hidden="true" tabindex="-1"></a>mashroom.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">target</th>
<th data-quarto-table-cell-role="th">shape</th>
<th data-quarto-table-cell-role="th">surface</th>
<th data-quarto-table-cell-role="th">color</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>edible</td>
<td>convex</td>
<td>smooth</td>
<td>yellow</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>edible</td>
<td>bell</td>
<td>smooth</td>
<td>white</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>poisonous</td>
<td>convex</td>
<td>scaly</td>
<td>white</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>edible</td>
<td>convex</td>
<td>smooth</td>
<td>gray</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>edible</td>
<td>convex</td>
<td>scaly</td>
<td>yellow</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="問題タイタニック" class="level3">
<h3 class="anchored" data-anchor-id="問題タイタニック">問題（タイタニック）</h3>
<p>titanicデータに対して深層学習を行い，死亡確率の推定を行え．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>titanic <span class="op">=</span> pd.read_csv(<span class="st">"http://logopt.com/data/titanic.csv"</span>)</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>titanic.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">PassengerId</th>
<th data-quarto-table-cell-role="th">Survived</th>
<th data-quarto-table-cell-role="th">Pclass</th>
<th data-quarto-table-cell-role="th">Name</th>
<th data-quarto-table-cell-role="th">Sex</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">SibSp</th>
<th data-quarto-table-cell-role="th">Parch</th>
<th data-quarto-table-cell-role="th">Ticket</th>
<th data-quarto-table-cell-role="th">Fare</th>
<th data-quarto-table-cell-role="th">Cabin</th>
<th data-quarto-table-cell-role="th">Embarked</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>0</td>
<td>3</td>
<td>Braund, Mr. Owen Harris</td>
<td>male</td>
<td>22.0</td>
<td>1</td>
<td>0</td>
<td>A/5 21171</td>
<td>7.2500</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>1</td>
<td>1</td>
<td>Cumings, Mrs. John Bradley (Florence Briggs Thayer)</td>
<td>female</td>
<td>38.0</td>
<td>1</td>
<td>0</td>
<td>PC 17599</td>
<td>71.2833</td>
<td>C85</td>
<td>C</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>1</td>
<td>3</td>
<td>Heikkinen, Miss. Laina</td>
<td>female</td>
<td>26.0</td>
<td>0</td>
<td>0</td>
<td>STON/O2. 3101282</td>
<td>7.9250</td>
<td>NaN</td>
<td>S</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>1</td>
<td>1</td>
<td>Futrelle, Mrs. Jacques Heath (Lily May Peel)</td>
<td>female</td>
<td>35.0</td>
<td>1</td>
<td>0</td>
<td>113803</td>
<td>53.1000</td>
<td>C123</td>
<td>S</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>0</td>
<td>3</td>
<td>Allen, Mr. William Henry</td>
<td>male</td>
<td>35.0</td>
<td>0</td>
<td>0</td>
<td>373450</td>
<td>8.0500</td>
<td>NaN</td>
<td>S</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="問題胸部癌" class="level3">
<h3 class="anchored" data-anchor-id="問題胸部癌">問題（胸部癌）</h3>
<p>http://logopt.com/data/cancer.csv にある胸部癌か否かを判定するデータセットを用いて，深層学習による分類を行え．</p>
<p>最初の列<strong>diagnosis</strong>が癌か否かを表すものであり，“M”が悪性（malignant），“B”が良性（benign）を表す．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>cancer <span class="op">=</span> pd.read_csv(<span class="st">"http://logopt.com/data/cancer.csv"</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a>cancer.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">diagnosis</th>
<th data-quarto-table-cell-role="th">radius_mean</th>
<th data-quarto-table-cell-role="th">texture_mean</th>
<th data-quarto-table-cell-role="th">perimeter_mean</th>
<th data-quarto-table-cell-role="th">area_mean</th>
<th data-quarto-table-cell-role="th">smoothness_mean</th>
<th data-quarto-table-cell-role="th">compactness_mean</th>
<th data-quarto-table-cell-role="th">concavity_mean</th>
<th data-quarto-table-cell-role="th">concave points_mean</th>
<th data-quarto-table-cell-role="th">symmetry_mean</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">radius_worst</th>
<th data-quarto-table-cell-role="th">texture_worst</th>
<th data-quarto-table-cell-role="th">perimeter_worst</th>
<th data-quarto-table-cell-role="th">area_worst</th>
<th data-quarto-table-cell-role="th">smoothness_worst</th>
<th data-quarto-table-cell-role="th">compactness_worst</th>
<th data-quarto-table-cell-role="th">concavity_worst</th>
<th data-quarto-table-cell-role="th">concave points_worst</th>
<th data-quarto-table-cell-role="th">symmetry_worst</th>
<th data-quarto-table-cell-role="th">fractal_dimension_worst</th>
</tr>
<tr class="odd">
<th data-quarto-table-cell-role="th">id</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">842302</td>
<td>M</td>
<td>17.99</td>
<td>10.38</td>
<td>122.80</td>
<td>1001.0</td>
<td>0.11840</td>
<td>0.27760</td>
<td>0.3001</td>
<td>0.14710</td>
<td>0.2419</td>
<td>...</td>
<td>25.38</td>
<td>17.33</td>
<td>184.60</td>
<td>2019.0</td>
<td>0.1622</td>
<td>0.6656</td>
<td>0.7119</td>
<td>0.2654</td>
<td>0.4601</td>
<td>0.11890</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">842517</td>
<td>M</td>
<td>20.57</td>
<td>17.77</td>
<td>132.90</td>
<td>1326.0</td>
<td>0.08474</td>
<td>0.07864</td>
<td>0.0869</td>
<td>0.07017</td>
<td>0.1812</td>
<td>...</td>
<td>24.99</td>
<td>23.41</td>
<td>158.80</td>
<td>1956.0</td>
<td>0.1238</td>
<td>0.1866</td>
<td>0.2416</td>
<td>0.1860</td>
<td>0.2750</td>
<td>0.08902</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">84300903</td>
<td>M</td>
<td>19.69</td>
<td>21.25</td>
<td>130.00</td>
<td>1203.0</td>
<td>0.10960</td>
<td>0.15990</td>
<td>0.1974</td>
<td>0.12790</td>
<td>0.2069</td>
<td>...</td>
<td>23.57</td>
<td>25.53</td>
<td>152.50</td>
<td>1709.0</td>
<td>0.1444</td>
<td>0.4245</td>
<td>0.4504</td>
<td>0.2430</td>
<td>0.3613</td>
<td>0.08758</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">84348301</td>
<td>M</td>
<td>11.42</td>
<td>20.38</td>
<td>77.58</td>
<td>386.1</td>
<td>0.14250</td>
<td>0.28390</td>
<td>0.2414</td>
<td>0.10520</td>
<td>0.2597</td>
<td>...</td>
<td>14.91</td>
<td>26.50</td>
<td>98.87</td>
<td>567.7</td>
<td>0.2098</td>
<td>0.8663</td>
<td>0.6869</td>
<td>0.2575</td>
<td>0.6638</td>
<td>0.17300</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">84358402</td>
<td>M</td>
<td>20.29</td>
<td>14.34</td>
<td>135.10</td>
<td>1297.0</td>
<td>0.10030</td>
<td>0.13280</td>
<td>0.1980</td>
<td>0.10430</td>
<td>0.1809</td>
<td>...</td>
<td>22.54</td>
<td>16.67</td>
<td>152.20</td>
<td>1575.0</td>
<td>0.1374</td>
<td>0.2050</td>
<td>0.4000</td>
<td>0.1625</td>
<td>0.2364</td>
<td>0.07678</td>
</tr>
</tbody>
</table>

<p>5 rows × 31 columns</p>
</div>
</div>
</div>
</section>
<section id="問題部屋" class="level3">
<h3 class="anchored" data-anchor-id="問題部屋">問題（部屋）</h3>
<p>以下の部屋が使われているか否かを判定するデータに対して，深層学習による分類を行え．</p>
<p><strong>occupancy</strong>列が部屋が使われているか否かを表す情報であり，これを<strong>datetime</strong>列以外の情報から分類せよ．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>occupancy <span class="op">=</span> pd.read_csv(<span class="st">"http://logopt.com/data/occupancy.csv"</span>)</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>occupancy.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">datetime</th>
<th data-quarto-table-cell-role="th">temperature</th>
<th data-quarto-table-cell-role="th">relative humidity</th>
<th data-quarto-table-cell-role="th">light</th>
<th data-quarto-table-cell-role="th">CO2</th>
<th data-quarto-table-cell-role="th">humidity</th>
<th data-quarto-table-cell-role="th">occupancy</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2015-02-04 17:51:00</td>
<td>23.18</td>
<td>27.2720</td>
<td>426.0</td>
<td>721.25</td>
<td>0.004793</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2015-02-04 17:51:59</td>
<td>23.15</td>
<td>27.2675</td>
<td>429.5</td>
<td>714.00</td>
<td>0.004783</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2015-02-04 17:53:00</td>
<td>23.15</td>
<td>27.2450</td>
<td>426.0</td>
<td>713.50</td>
<td>0.004779</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2015-02-04 17:54:00</td>
<td>23.15</td>
<td>27.2000</td>
<td>426.0</td>
<td>708.25</td>
<td>0.004772</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2015-02-04 17:55:00</td>
<td>23.10</td>
<td>27.2000</td>
<td>426.0</td>
<td>704.50</td>
<td>0.004757</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
</section>
<section id="画像データ" class="level2">
<h2 class="anchored" data-anchor-id="画像データ">画像データ</h2>
<p>データ一覧は Data Externalにある．</p>
<p>http://docs.fast.ai/data.external#download_url</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="複数のラベルを生成する分類" class="level3">
<h3 class="anchored" data-anchor-id="複数のラベルを生成する分類">複数のラベルを生成する分類</h3>
<p>PASCAL_2007データを読み込み，複数のラベルの予測を行う．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.vision.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.PASCAL_2007)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>df <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">"train.csv"</span>)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">fname</th>
<th data-quarto-table-cell-role="th">labels</th>
<th data-quarto-table-cell-role="th">is_valid</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>000005.jpg</td>
<td>chair</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>000007.jpg</td>
<td>car</td>
<td>True</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>000009.jpg</td>
<td>horse person</td>
<td>True</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>000012.jpg</td>
<td>car</td>
<td>False</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>000016.jpg</td>
<td>bicycle</td>
<td>True</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>データブロック DataBlockを始めに生成して，それからデータローダーを作る．</p>
<p>データブロックは，以下の引数をもつ．</p>
<ul>
<li>blocks: データブロックを構成するブロックのタプル； 画像ブロックと（複数の）カテゴリーブロック</li>
<li>splitter: 訓練データと検証データのインデックスを返す関数</li>
<li>get_x: 独立変数（特徴ベクトル）を返す関数</li>
<li>get_y: 従属変数（ターゲット）を返す関数</li>
<li>item_tfms: 個々のデータの変換の指示</li>
<li>batch_tfms: バッチに対する変換の指示</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_x(r): <span class="cf">return</span> path<span class="op">/</span><span class="st">"train"</span><span class="op">/</span>r[<span class="st">"fname"</span>]</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_y(r): <span class="cf">return</span> r[<span class="st">"labels"</span>].split(<span class="st">" "</span>)</span>
<span id="cb77-3"><a href="#cb77-3" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> splitter(df):</span>
<span id="cb77-4"><a href="#cb77-4" aria-hidden="true" tabindex="-1"></a>    train <span class="op">=</span> df.index[df[<span class="st">"is_valid"</span>]].tolist()</span>
<span id="cb77-5"><a href="#cb77-5" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> df.index[df[<span class="st">"is_valid"</span>]].tolist()</span>
<span id="cb77-6"><a href="#cb77-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> train,valid</span>
<span id="cb77-7"><a href="#cb77-7" aria-hidden="true" tabindex="-1"></a>dblock <span class="op">=</span> DataBlock(blocks<span class="op">=</span>(ImageBlock, MultiCategoryBlock),</span>
<span id="cb77-8"><a href="#cb77-8" aria-hidden="true" tabindex="-1"></a>                   splitter<span class="op">=</span>splitter,</span>
<span id="cb77-9"><a href="#cb77-9" aria-hidden="true" tabindex="-1"></a>                   get_x<span class="op">=</span>get_x, </span>
<span id="cb77-10"><a href="#cb77-10" aria-hidden="true" tabindex="-1"></a>                   get_y<span class="op">=</span>get_y,</span>
<span id="cb77-11"><a href="#cb77-11" aria-hidden="true" tabindex="-1"></a>                   item_tfms <span class="op">=</span> RandomResizedCrop(<span class="dv">128</span>, min_scale<span class="op">=</span><span class="fl">0.35</span>))</span>
<span id="cb77-12"><a href="#cb77-12" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> dblock.dataloaders(df)</span>
<span id="cb77-13"><a href="#cb77-13" aria-hidden="true" tabindex="-1"></a>dls.show_batch(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-63-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>評価尺度には多ラベル用の正解率 accuracy_multiを用いる． また，関数partialで，引数の閾値（thresh)を0.2に固定して渡す． partialは標準モジュールのfunctoolsに含まれているが，fastaiではすでにimportした状態になっている．</p>
<p>fine_tuneで訓練をするが，最終層以外を固定して（freezeして）４エポック訓練し，その後，最終層以外も自由にして3エポック訓練する．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet50, metrics<span class="op">=</span>partial(accuracy_multi, thresh<span class="op">=</span><span class="fl">0.2</span>))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">3</span>, base_lr<span class="op">=</span><span class="fl">3e-3</span>, freeze_epochs<span class="op">=</span><span class="dv">4</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet50-19c8e357.pth" to /root/.cache/torch/hub/checkpoints/resnet50-19c8e357.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"979ed9de14c04ed0bf8258dddb538e24","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy_multi</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.939143</td>
<td>0.686238</td>
<td>0.235538</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.824816</td>
<td>0.574355</td>
<td>0.280578</td>
<td>00:27</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.605865</td>
<td>0.203421</td>
<td>0.807829</td>
<td>00:28</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.359789</td>
<td>0.127288</td>
<td>0.937928</td>
<td>00:28</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy_multi</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.138787</td>
<td>0.124408</td>
<td>0.941434</td>
<td>00:29</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.118910</td>
<td>0.108459</td>
<td>0.948426</td>
<td>00:29</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.097468</td>
<td>0.105211</td>
<td>0.952430</td>
<td>00:29</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-65-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="画像から人の頭の中心を当てる回帰" class="level3">
<h3 class="anchored" data-anchor-id="画像から人の頭の中心を当てる回帰">画像から人の頭の中心を当てる回帰</h3>
<p>画像データは分類だけでなく，回帰を行うこともできる． BIWIデータを読み込み，サンプル画像を表示する．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb82"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.BIWI_HEAD_POSE)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>img_files <span class="op">=</span> get_image_files(path)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> img2pose(x): <span class="cf">return</span> Path(<span class="ss">f"</span><span class="sc">{</span><span class="bu">str</span>(x)[:<span class="op">-</span><span class="dv">7</span>]<span class="sc">}</span><span class="ss">pose.txt"</span>)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>img2pose(img_files[<span class="dv">0</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>Path('/root/.fastai/data/biwi_head_pose/06/frame_00079_pose.txt')</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>cal <span class="op">=</span> np.genfromtxt(path<span class="op">/</span><span class="st">"01"</span><span class="op">/</span><span class="st">"rgb.cal"</span>, skip_footer<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb85-2"><a href="#cb85-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> get_ctr(f):</span>
<span id="cb85-3"><a href="#cb85-3" aria-hidden="true" tabindex="-1"></a>    ctr <span class="op">=</span> np.genfromtxt(img2pose(f), skip_header<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb85-4"><a href="#cb85-4" aria-hidden="true" tabindex="-1"></a>    c1 <span class="op">=</span> ctr[<span class="dv">0</span>] <span class="op">*</span> cal[<span class="dv">0</span>][<span class="dv">0</span>]<span class="op">/</span>ctr[<span class="dv">2</span>] <span class="op">+</span> cal[<span class="dv">0</span>][<span class="dv">2</span>]</span>
<span id="cb85-5"><a href="#cb85-5" aria-hidden="true" tabindex="-1"></a>    c2 <span class="op">=</span> ctr[<span class="dv">1</span>] <span class="op">*</span> cal[<span class="dv">1</span>][<span class="dv">1</span>]<span class="op">/</span>ctr[<span class="dv">2</span>] <span class="op">+</span> cal[<span class="dv">1</span>][<span class="dv">2</span>]</span>
<span id="cb85-6"><a href="#cb85-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> tensor([c1,c2])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>biwi <span class="op">=</span> DataBlock(</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>(ImageBlock, PointBlock),</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_image_files,</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    get_y<span class="op">=</span>get_ctr,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>    splitter<span class="op">=</span>FuncSplitter(<span class="kw">lambda</span> o: o.parent.name<span class="op">==</span><span class="st">"13"</span>),</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>    batch_tfms<span class="op">=</span>[<span class="op">*</span>aug_transforms(size<span class="op">=</span>(<span class="dv">240</span>,<span class="dv">320</span>)), </span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>                Normalize.from_stats(<span class="op">*</span>imagenet_stats)]</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> biwi.dataloaders(path)</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>dls.show_batch(max_n<span class="op">=</span><span class="dv">9</span>, figsize<span class="op">=</span>(<span class="dv">8</span>,<span class="dv">6</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-70-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> vision_learner(dls, resnet18, y_range<span class="op">=</span>(<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>))</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>learn.lr_find()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Downloading: "https://download.pytorch.org/models/resnet18-5c106cde.pth" to /root/.cache/torch/hub/checkpoints/resnet18-5c106cde.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"135ede9dbcb2463aa45d32a3ddcbb2c3","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>SuggestedLRs(lr_min=0.004786301031708717, lr_steep=1.3182567499825382e-06)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-71-output-6.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">4</span>, <span class="fl">5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.052732</td>
<td>0.005105</td>
<td>02:07</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.005605</td>
<td>0.001754</td>
<td>02:17</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.003696</td>
<td>0.001718</td>
<td>02:17</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.002149</td>
<td>0.000066</td>
<td>02:16</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.001374</td>
<td>0.000060</td>
<td>02:18</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>正解と予測を表示</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>learn.show_results()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-73-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="協調フィルタリング" class="level2">
<h2 class="anchored" data-anchor-id="協調フィルタリング">協調フィルタリング</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.tabular.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span>
<span id="cb94-2"><a href="#cb94-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.collab <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>協調フィルタリング(collaborative filtering)とは，推奨システム(recommender system)の一種で，ユーザーとアイテムの両方の潜在因子を考慮して，レーティングを決める手法だ．</p>
<p>推奨システムでよく見かけるのは，「この商品を買った人はこの商品も買っています」とか「最も良く売れているのはこの商品です」などの猿でもできるタイプのものだ．このような単純なものではなく，あなたに似た潜在因子をもつ人が，高いレーティングをつけている（もしくは良く購入する）商品に近い潜在因子をもった商品を紹介するのが，協調フィルタリングである．</p>
<p>機械学習の中で（Andrew Ngが実務家から聞いた話だが）実務で最も役に立つ，もしくは期待されているのがこれだ． 背景にある理論を簡単に紹介しよう．</p>
<p>いま，顧客と商品の集合とともに，商品 <span class="math inline">\(i\)</span> に対して顧客 <span class="math inline">\(j\)</span> が評価を行ったデータが与えられているものとする． ただし，顧客が評価をつけた商品は通常は少なく，データは極めて疎な行列として与えられている． 商品 <span class="math inline">\(i\)</span> に対して顧客 <span class="math inline">\(j\)</span> が評価を行っているとき <span class="math inline">\(1\)</span>，それ以外のとき <span class="math inline">\(0\)</span> のパラメータを <span class="math inline">\(r(i,j)\)</span> とする． <span class="math inline">\(r(i,j)=1\)</span> の場合には，顧客 <span class="math inline">\(j\)</span> は商品 <span class="math inline">\(i\)</span> に対して離散値の（たとえば <span class="math inline">\(1\)</span> から <span class="math inline">\(5\)</span> の整数などで）評価点をつける． この評価点を表すデータを <span class="math inline">\(y^{(i,j)}\)</span> とする．これがトレーニングデータになる． これをもとに，評価点がつけられていない（<span class="math inline">\(r(i,j)=0\)</span> の）場所の評価点を推定することが問題の目的となる．</p>
<p>推奨システム設計のための手法は， <strong>コンテンツベース推奨</strong>(contents based recommendation)と<strong>協調フィルタリング推奨</strong>(collaborative filtering recommendation)の2つに分類できる．</p>
<p>コンテンツベース推奨では，商品 <span class="math inline">\(i\)</span> に対する特徴ベクトル <span class="math inline">\(x^{(i)} \in R^n\)</span> が与えられていると仮定する． たとえば，商品を映画としたときに，特徴ベクトルは映画の種別（アクション，SF，ホラー，恋愛もの，スリラー ，ファンタジーなど）の度合いを表す． たとえば，スターウォーズはSF度 <span class="math inline">\(0.8\)</span>，恋愛度 <span class="math inline">\(0.1\)</span>，アクション度 <span class="math inline">\(0.1\)</span> と採点される．</p>
<p>顧客 <span class="math inline">\(j\)</span> の特徴に対する重みベクトルを <span class="math inline">\(w^{(j)} \in R^n\)</span> とする．これは顧客がどういった映画の種別を好むのかを表す． これを線形回帰を用いて求めることを考えると仮説関数は， <span class="math display">\[
  h_w (x)=w_1 x_1 + w_2 x_2 + \cdots + w_n x_n  
\]</span> となる． 最適な重みを計算するには，以下に定義される費用関数を最小にする重みベクトル <span class="math inline">\(w^{(j)}\)</span> を求めればよい． <span class="math display">\[
\frac{1}{2} \sum_{i: r(i,j) = 1 } \left(  (w^{(j)})^T (x^{(i)}) -y^{(i,j)} \right)^2
\]</span></p>
<p>映画ごとに特徴を見積もることは実際には難しい． そこで，協調フィルタリング推奨では，商品ごとの特徴ベクトル <span class="math inline">\(x^{(i)} \in R^n\)</span> を定数として与えるのではなく， 変数とみなして顧客ごとの重みと同時に最適化を行う． すべての顧客と商品に対するトレーニングデータとの誤差の2乗和を最小化する問題は，以下のように書ける． <span class="math display">\[
\min_{w, x} \frac{1}{2} \sum_{(i,j): r(i,j) = 1 } \left(  (w^{(j)})^T (x^{(i)}) -y^{(i,j)} \right)^2
\]</span></p>
<p>この問題を直接最適化してもよいが，<span class="math inline">\(x\)</span> と <span class="math inline">\(w\)</span> を交互に線形回帰を用いて解く簡便法も考えられる． すなわち，適当な特徴ベクトルの推定値 <span class="math inline">\(x^{(i)}\)</span> を用いて顧客 <span class="math inline">\(j\)</span> に対する重みベクトル <span class="math inline">\(w^{(j)}\)</span> を求めた後に， 今度は <span class="math inline">\(w^{(j)}\)</span> を用いて <span class="math inline">\(x^{(i)}\)</span> を求めるのである．この操作を収束するまで繰り返せばよい．</p>
<p>上のアルゴリズムを用いて得られた商品 <span class="math inline">\(i\)</span> の特徴ベクトル <span class="math inline">\(x^{(i)}\)</span> を用いると， 類似の商品を抽出することができる． たとえば，<span class="math inline">\(x^{(i)}\)</span> を <span class="math inline">\(n\)</span>次元空間内の点とみなしてクラスタリングを行うことによって， 商品のクラスタリングができる．同様に顧客 <span class="math inline">\(j\)</span> の重みベクトル <span class="math inline">\(w^{(j)}\)</span> を用いることによって顧客のクラスタリングができる．</p>
<p>有名な例題（映画の評価値を当てる）であるMovieLensのデータを読み込む．</p>
<p>データにはtimestamp列がついているが，とりあえずこれは無視してレーティング(rating)を予測してみる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.ML_100k)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">"u.data"</span>, delimiter<span class="op">=</span><span class="st">"</span><span class="ch">\t</span><span class="st">"</span>, header<span class="op">=</span><span class="va">None</span>,</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a>                      usecols<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>,<span class="dv">2</span>), names<span class="op">=</span>[<span class="st">"user"</span>,<span class="st">"movie"</span>,<span class="st">"rating"</span>])</span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a>ratings.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>196</td>
<td>242</td>
<td>3</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>186</td>
<td>302</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>22</td>
<td>377</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>244</td>
<td>51</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>166</td>
<td>346</td>
<td>1</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>movies <span class="op">=</span> pd.read_csv(path<span class="op">/</span><span class="st">"u.item"</span>,  delimiter<span class="op">=</span><span class="st">"|"</span>, encoding<span class="op">=</span><span class="st">"latin-1"</span>,</span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>                     usecols<span class="op">=</span>(<span class="dv">0</span>,<span class="dv">1</span>), names<span class="op">=</span>(<span class="st">"movie"</span>,<span class="st">"title"</span>), header<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>movies.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>1</td>
<td>Toy Story (1995)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>GoldenEye (1995)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>3</td>
<td>Four Rooms (1995)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4</td>
<td>Get Shorty (1995)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5</td>
<td>Copycat (1995)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>ratings <span class="op">=</span> ratings.merge(movies)</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>ratings.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">movie</th>
<th data-quarto-table-cell-role="th">rating</th>
<th data-quarto-table-cell-role="th">title</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>196</td>
<td>242</td>
<td>3</td>
<td>Kolya (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>63</td>
<td>242</td>
<td>3</td>
<td>Kolya (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>226</td>
<td>242</td>
<td>5</td>
<td>Kolya (1996)</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>154</td>
<td>242</td>
<td>3</td>
<td>Kolya (1996)</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>306</td>
<td>242</td>
<td>5</td>
<td>Kolya (1996)</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>CollabDataLoadersクラスのfrom_dfメソッドにデータフレームを入れるとデータオブジェクトを作成してくれる．</p>
<p>引数はデータフレーム(ratings)，検証データの比率(pct_val)，ユーザー，アイテム，レーティングを表す列名だ．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> CollabDataLoaders.from_df(ratings, item_name<span class="op">=</span><span class="st">"title"</span>, bs<span class="op">=</span><span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>作成したデータオブジェクトをcollab_learner関数に入れると学習器（誤差を最小にする潜在因子行列の重みの最適化が目的）を作ってくれる．予測したいレーティングは，星５つまでなので，y_rangeで指定する．</p>
<p>データオブジェクト(data)，潜在因子の数(n_factors)を指定しているが，他にもmetricsは評価尺度，wdはweight decayで正則化のためのパラメータなどを指定できる．</p>
<pre><code>def collab_learner(data, n_factors:int=None, use_nn:bool=False, metrics=None,
                  emb_szs:Dict[str,int]=None, wd:float=0.01, **kwargs)-&gt;Learner</code></pre>
<div class="cell">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a>dls.show_batch()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">user</th>
<th data-quarto-table-cell-role="th">title</th>
<th data-quarto-table-cell-role="th">rating</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>348</td>
<td>Jack (1996)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>346</td>
<td>Twelve Monkeys (1995)</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>110</td>
<td>Simple Twist of Fate, A (1994)</td>
<td>2</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>72</td>
<td>Conan the Barbarian (1981)</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>864</td>
<td>Death and the Maiden (1994)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>347</td>
<td>Twelve Monkeys (1995)</td>
<td>4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>731</td>
<td>Sabrina (1954)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>751</td>
<td>Raising Arizona (1987)</td>
<td>3</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>344</td>
<td>Leaving Las Vegas (1995)</td>
<td>4</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>577</td>
<td>Devil in a Blue Dress (1995)</td>
<td>4</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> collab_learner(dls, n_factors<span class="op">=</span><span class="dv">50</span>, y_range<span class="op">=</span>(<span class="dv">0</span>, <span class="fl">5.5</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">5e-3</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.935071</td>
<td>0.929474</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.812040</td>
<td>0.860315</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.631619</td>
<td>0.864089</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.400996</td>
<td>0.885280</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.289997</td>
<td>0.891847</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>検証の損出関数をみると、過剰適合しているようだ（途中まで下がっているが、最後は上昇している）。</p>
<p>L2正則化関数を入れてみよう。fastaiでは、重み減衰 (weight decay: wd) という引数で指定する。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a>learn.fit_one_cycle(<span class="dv">5</span>, <span class="fl">5e-3</span>, wd<span class="op">=</span><span class="fl">0.1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.952608</td>
<td>0.940679</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.839875</td>
<td>0.867949</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.742433</td>
<td>0.825799</td>
<td>00:06</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.591568</td>
<td>0.814826</td>
<td>00:06</td>
</tr>
<tr class="odd">
<td>4</td>
<td>0.479914</td>
<td>0.816404</td>
<td>00:06</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>訓練ロスは悪化しているが、検証ロスは改善していることが確認できる。</p>
<p>トップ1000の映画を抽出し、埋め込み層の重みを主成分分析で2次元に落として描画してみる。</p>
<p>ニューラルネットが、自動的に映画の特徴を抽出していることが確認できる。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>g <span class="op">=</span> ratings.groupby(<span class="st">"title"</span>)[<span class="st">"rating"</span>].count()</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a>top_movies <span class="op">=</span> g.sort_values(ascending<span class="op">=</span><span class="va">False</span>).index.values[:<span class="dv">1000</span>]</span>
<span id="cb104-3"><a href="#cb104-3" aria-hidden="true" tabindex="-1"></a>top_idxs <span class="op">=</span> tensor([learn.dls.classes[<span class="st">"title"</span>].o2i[m] <span class="cf">for</span> m <span class="kw">in</span> top_movies])</span>
<span id="cb104-4"><a href="#cb104-4" aria-hidden="true" tabindex="-1"></a>movie_w <span class="op">=</span> learn.model.i_weight.weight[top_idxs].cpu().detach()</span>
<span id="cb104-5"><a href="#cb104-5" aria-hidden="true" tabindex="-1"></a>movie_pca <span class="op">=</span> movie_w.pca(<span class="dv">3</span>)</span>
<span id="cb104-6"><a href="#cb104-6" aria-hidden="true" tabindex="-1"></a>fac0,fac1,fac2 <span class="op">=</span> movie_pca.t()</span>
<span id="cb104-7"><a href="#cb104-7" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> np.random.choice(<span class="bu">len</span>(top_movies), <span class="dv">50</span>, replace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb104-8"><a href="#cb104-8" aria-hidden="true" tabindex="-1"></a>idxs <span class="op">=</span> <span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">100</span>))</span>
<span id="cb104-9"><a href="#cb104-9" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> fac0[idxs]</span>
<span id="cb104-10"><a href="#cb104-10" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> fac2[idxs]</span>
<span id="cb104-11"><a href="#cb104-11" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>,<span class="dv">12</span>))</span>
<span id="cb104-12"><a href="#cb104-12" aria-hidden="true" tabindex="-1"></a>plt.scatter(X, Y)</span>
<span id="cb104-13"><a href="#cb104-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, x, y <span class="kw">in</span> <span class="bu">zip</span>(top_movies[idxs], X, Y):</span>
<span id="cb104-14"><a href="#cb104-14" aria-hidden="true" tabindex="-1"></a>    plt.text(x,y,i, color<span class="op">=</span>np.random.rand(<span class="dv">3</span>)<span class="op">*</span><span class="fl">0.7</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb104-15"><a href="#cb104-15" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-83-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="意味分割" class="level2">
<h2 class="anchored" data-anchor-id="意味分割">意味分割</h2>
<p>以下のデータセットは、与えられた画像の分割（各ピクセルがどの物体に属するのかを分類すること；これを意味分割(semantic segmentation)と呼ぶ）に用いられる。</p>
<ul>
<li>Camvid: Motion-based Segmentation and Recognition Dataset (CAMVID, CAMVID_TINY)</li>
</ul>
<div class="cell">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.CAMVID_TINY)</span>
<span id="cb105-2"><a href="#cb105-2" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> SegmentationDataLoaders.from_label_func(</span>
<span id="cb105-3"><a href="#cb105-3" aria-hidden="true" tabindex="-1"></a>    path, bs<span class="op">=</span><span class="dv">8</span>, fnames <span class="op">=</span> get_image_files(path<span class="op">/</span><span class="st">"images"</span>),</span>
<span id="cb105-4"><a href="#cb105-4" aria-hidden="true" tabindex="-1"></a>    label_func <span class="op">=</span> <span class="kw">lambda</span> o: path<span class="op">/</span><span class="st">"labels"</span><span class="op">/</span><span class="ss">f"</span><span class="sc">{</span>o<span class="sc">.</span>stem<span class="sc">}</span><span class="ss">_P</span><span class="sc">{</span>o<span class="sc">.</span>suffix<span class="sc">}</span><span class="ss">"</span>,</span>
<span id="cb105-5"><a href="#cb105-5" aria-hidden="true" tabindex="-1"></a>    codes <span class="op">=</span> np.loadtxt(path<span class="op">/</span><span class="st">"codes.txt"</span>, dtype<span class="op">=</span><span class="bu">str</span>)</span>
<span id="cb105-6"><a href="#cb105-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb105-7"><a href="#cb105-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb105-8"><a href="#cb105-8" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> unet_learner(dls, resnet34)</span>
<span id="cb105-9"><a href="#cb105-9" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">8</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/torchvision/models/_utils.py:209: UserWarning: The parameter 'pretrained' is deprecated since 0.13 and will be removed in 0.15, please use 'weights' instead.
  f"The parameter '{pretrained_param}' is deprecated since 0.13 and will be removed in 0.15, "
/usr/local/lib/python3.7/dist-packages/torchvision/models/_utils.py:223: UserWarning: Arguments other than a weight enum or `None` for 'weights' are deprecated since 0.13 and will be removed in 0.15. The current behavior is equivalent to passing `weights=ResNet34_Weights.IMAGENET1K_V1`. You can also use `weights=ResNet34_Weights.DEFAULT` to get the most up-to-date weights.
  warnings.warn(msg)
Downloading: "https://download.pytorch.org/models/resnet34-b627a593.pth" to /root/.cache/torch/hub/checkpoints/resnet34-b627a593.pth</code></pre>
</div>
<div class="cell-output cell-output-display">
<script type="application/vnd.jupyter.widget-view+json">
{"model_id":"c038bba6e94c4e80a78680acad00edb5","version_major":2,"version_minor":0,"quarto_mimetype":"application/vnd.jupyter.widget-view+json"}
</script>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.760665</td>
<td>5.930563</td>
<td>01:09</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">

<style>
    /* Turns off some styling */
    progress {
        /* gets rid of default border in Firefox and Opera. */
        border: none;
        /* Needs to be in here for Safari polyfill so background images work as expected. */
        background-size: auto;
    }
    progress:not([value]), progress:not([value])::-webkit-progress-bar {
        background: repeating-linear-gradient(45deg, #7e7e7e, #7e7e7e 10px, #5c5c5c 10px, #5c5c5c 20px);
    }
    .progress-bar-interrupted, .progress-bar-interrupted::-webkit-progress-bar {
        background: #F44336;
    }
</style>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>2.219755</td>
<td>1.865447</td>
<td>01:15</td>
</tr>
<tr class="even">
<td>1</td>
<td>1.819075</td>
<td>1.280244</td>
<td>01:20</td>
</tr>
<tr class="odd">
<td>2</td>
<td>1.559273</td>
<td>1.177241</td>
<td>01:17</td>
</tr>
<tr class="even">
<td>3</td>
<td>1.374030</td>
<td>0.868488</td>
<td>01:16</td>
</tr>
<tr class="odd">
<td>4</td>
<td>1.210444</td>
<td>0.832017</td>
<td>01:16</td>
</tr>
<tr class="even">
<td>5</td>
<td>1.082514</td>
<td>0.755146</td>
<td>01:16</td>
</tr>
<tr class="odd">
<td>6</td>
<td>0.980371</td>
<td>0.728570</td>
<td>01:15</td>
</tr>
<tr class="even">
<td>7</td>
<td>0.902825</td>
<td>0.727522</td>
<td>01:16</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>learn.show_results(max_n<span class="op">=</span><span class="dv">6</span>, figsize<span class="op">=</span>(<span class="dv">7</span>,<span class="dv">8</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-85-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="テキストデータ" class="level2">
<h2 class="anchored" data-anchor-id="テキストデータ">テキストデータ</h2>
<p>fastaiでは，Wikipediaの膨大なテキストデータを用いた学習済みの言語モデルであるAWD_LSTMを準備している． 映画の批評データを用いて，fastaiの自然言語処理を試してみる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb108"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb108-1"><a href="#cb108-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.text.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a>path <span class="op">=</span> untar_data(URLs.IMDB)</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>get_imdb <span class="op">=</span> partial(get_text_files, folders<span class="op">=</span>[<span class="st">"train"</span>, <span class="st">"test"</span>, <span class="st">"unsup"</span>])</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>dls_lm <span class="op">=</span> DataBlock(</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>    blocks<span class="op">=</span>TextBlock.from_folder(path, is_lm<span class="op">=</span><span class="va">True</span>),</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>    get_items<span class="op">=</span>get_imdb, splitter<span class="op">=</span>RandomSplitter(<span class="fl">0.1</span>)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a>).dataloaders(path, path<span class="op">=</span>path, bs<span class="op">=</span><span class="dv">128</span>, seq_len<span class="op">=</span><span class="dv">80</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>言語モデルのデータブロック dls_lm をもとに，学習済のパラメータAWD_LSTMを読み込んで学習器をつくる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> language_model_learner(</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>    dls_lm, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.3</span>, </span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>    metrics<span class="op">=</span>[accuracy, Perplexity()]).to_fp16()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
</div>
<p>適当な文章TEXT を入れて，その後の文章を作らせる．tempertureは文章にランダム性を付与するために用いられる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>TEXT <span class="op">=</span> <span class="st">"This is a pen. That is an"</span></span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>N_WORDS <span class="op">=</span> <span class="dv">40</span></span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>N_SENTENCES <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> [learn.predict(TEXT, N_WORDS, temperature<span class="op">=</span><span class="fl">0.75</span>) </span>
<span id="cb111-5"><a href="#cb111-5" aria-hidden="true" tabindex="-1"></a>         <span class="cf">for</span> _ <span class="kw">in</span> <span class="bu">range</span>(N_SENTENCES)]</span>
<span id="cb111-6"><a href="#cb111-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<pre><code>["This is a pen . That is an allusion to what i ' ve known as The Radio Times . BBC Radio 1 ! is an example of how a different composer can work with an orchestra and which contains over half a",
 'This is a pen . That is an especially unusual phrase for an artist who has been ascribed to the term , and is sometimes referred to as the " Artist Generation " . The term is sometimes defined as defining the evolution of the']</code></pre>
</div>
</div>
<p>言語モデルを用いて，映画の批評のテキストが，ネガティブかパシティブかを判別する学習器をつくる．</p>
<p>映画批評のデータセットIMDBを読み込んで，言語モデル AWD_LSTM を用いて訓練する．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> fastai.text.<span class="bu">all</span> <span class="im">import</span> <span class="op">*</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>dls <span class="op">=</span> TextDataLoaders.from_folder(untar_data(URLs.IMDB), valid<span class="op">=</span><span class="st">"test"</span>)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>learn <span class="op">=</span> text_classifier_learner(dls, AWD_LSTM, drop_mult<span class="op">=</span><span class="fl">0.5</span>, metrics<span class="op">=</span>accuracy)</span>
<span id="cb114-3"><a href="#cb114-3" aria-hidden="true" tabindex="-1"></a>learn.fine_tune(<span class="dv">4</span>, <span class="fl">1e-2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.598281</td>
<td>0.404613</td>
<td>0.822120</td>
<td>04:11</td>
</tr>
</tbody>
</table>
</div>
<div class="cell-output cell-output-display">
<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">epoch</th>
<th data-quarto-table-cell-role="th">train_loss</th>
<th data-quarto-table-cell-role="th">valid_loss</th>
<th data-quarto-table-cell-role="th">accuracy</th>
<th data-quarto-table-cell-role="th">time</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>0</td>
<td>0.318746</td>
<td>0.245778</td>
<td>0.898840</td>
<td>07:56</td>
</tr>
<tr class="even">
<td>1</td>
<td>0.249433</td>
<td>0.221797</td>
<td>0.908000</td>
<td>08:07</td>
</tr>
<tr class="odd">
<td>2</td>
<td>0.183325</td>
<td>0.190910</td>
<td>0.926360</td>
<td>08:19</td>
</tr>
<tr class="even">
<td>3</td>
<td>0.153639</td>
<td>0.194017</td>
<td>0.926240</td>
<td>08:11</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>予測してみる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>( learn.predict(<span class="st">"I really liked that movie!"</span>) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">

</div>
<div class="cell-output cell-output-stdout">
<pre><code>('pos', tensor(1), tensor([3.4028e-04, 9.9966e-01]))</code></pre>
</div>
</div>
</section>
<section id="画像生成" class="level2">
<h2 class="anchored" data-anchor-id="画像生成">画像生成</h2>
<p>ちょっと前までは <strong>GAN</strong> (generative adversarial network; 敵対的生成ネットワーク)が流行していたが， 最近では <strong>拡散モデル</strong> (diffusion model)を用いて，高精度な画像を高速に生成することができるようになってきた．</p>
<section id="問題dalle-2" class="level3">
<h3 class="anchored" data-anchor-id="問題dalle-2">問題（DALL・E 2）</h3>
<p>DALL・E2 https://openai.com/dall-e-2/ に登録して，オリジナルの画像を生成せよ．</p>
<p>（<strong>注意：</strong> 生成できる画像数に制限がある（毎月リセットされる）</p>
</section>
<section id="問題hagging-face-diffusers" class="level3">
<h3 class="anchored" data-anchor-id="問題hagging-face-diffusers">問題（Hagging Face Diffusers）</h3>
<p>Diffusers https://github.com/huggingface/diffusers/ のQuickstartにある Getting started with Diffusers をGoogle Colab で開いて，ドライブにコピーを保存してから，最初の画像生成までを実行せよ．</p>
<p>（<strong>注意：</strong> ランタイムでGPUをオンにしてから実行する． 有料版のColab Pro(+)に登録する必要はない）</p>
</section>
<section id="問題-hagging-face" class="level3">
<h3 class="anchored" data-anchor-id="問題-hagging-face">問題 （Hagging Face)</h3>
<p>Hagging Face のモデル https://huggingface.co/models のTasks（+22 Taskを押すとたくさん出てくる)から好きなものを選び，試してみよ． また，どのようなモデルが使われているか解説を読み， （できれば） Google Colabで動かしてみよ．</p>
<p>（<strong>注意：</strong> しばらくはloginなしで使えるが，時間制限を超えるとloginが必要になる）</p>
</section>
</section>
<section id="深層学習の基礎を図で解説" class="level2">
<h2 class="anchored" data-anchor-id="深層学習の基礎を図で解説">深層学習の基礎を図で解説</h2>
<p>通常の（完全結合層から成る）ニューラルネットについては，scikit-learn を用いた機械学習の章で述べた． 以下では，本章で紹介した幾つかのアーキテクチャについて解説する．</p>
<section id="畳み込みニューラルネット" class="level3">
<h3 class="anchored" data-anchor-id="畳み込みニューラルネット">畳み込みニューラルネット</h3>
<p>画像データに対して完全結合層だけのニューラルネットを使うことは，膨大な量のパラメータを必要とするので，適当な選択ではない． 完全結合層のかわりに<strong>畳み込み</strong>(convolusion)を用いた層を用いる方法が，畳み込みニューラルネットである．</p>
<p>畳み込みニューラルネットでは，以下の図に示すように，畳み込み（一種のパラメータ行列の乗算）を行った後に，活性化関数としてLeLUを用い，さらにマックスプールでデータを小さくする操作を繰り返していく． そして，最後の層だけを完全結合層とし，分類もしくは回帰を行う．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-94-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-95-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="回帰型ニューラルネット" class="level3">
<h3 class="anchored" data-anchor-id="回帰型ニューラルネット">回帰型ニューラルネット</h3>
<p>文字列や音声などの時系列データを扱うためのニューラルネットとして，<strong>回帰型ニューラルネット</strong>(recurrent neural nettwork)がある．</p>
<p>長さ <span class="math inline">\(T\)</span> の時系列データ <span class="math inline">\(x^{&lt;1&gt;},x^{&lt;2&gt;},\ldots,x^{&lt;T&gt;}\)</span> が与えられたとき， 回帰型ニューラルネットは，初期状態 <span class="math inline">\(a^{&lt;0&gt;}\)</span> から状態の列 <span class="math inline">\(a^{&lt;1&gt;},a^{&lt;2&gt;},\ldots,a^{&lt;T&gt;}\)</span> を順次生成していく．</p>
<p>各時刻 <span class="math inline">\(t=1,2,\ldots,T\)</span> において，データ <span class="math inline">\(x^{&lt;t&gt;}\)</span> と前の状態 <span class="math inline">\(a^{&lt;t-1&gt;}\)</span> を結合したものを入力とし活性化関数（通常は<span class="math inline">\(\tanh\)</span>）を用いて，次の状態 <span class="math inline">\(a^{&lt;t&gt;}\)</span> を生成していく．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-96-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="長短期記憶" class="level3">
<h3 class="anchored" data-anchor-id="長短期記憶">長短期記憶</h3>
<p>回帰型ニューラルネットは，誤差逆伝播の際に勾配が無限大に発散したり消失してしまうという弱点をもっている． その弱点を克服するためのアーキテクチャとして，長短期記憶(long short-term memory: LSTM)がある．</p>
<p>LSTMの特徴は，長期の記憶のためのセル(cell) <span class="math inline">\(c^{&lt;t&gt;}\)</span> と，通常の状態（短期記憶に相当する） <span class="math inline">\(a^{&lt;t&gt;}\)</span> の両者を保持することである． この2種類の記憶情報を，シグモイド関数 <span class="math inline">\(\sigma\)</span> の出力（<span class="math inline">\(0\)</span> と <span class="math inline">\(1\)</span> の間になる）と乗じることによって， そのまま保持するかリセットするかを決め， 勾配発散（消失）を避けることができる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-97-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="埋め込みニューラルネット" class="level3">
<h3 class="anchored" data-anchor-id="埋め込みニューラルネット">埋め込みニューラルネット</h3>
<p>カテゴリーデータをより次元の低い特徴に写像するために<strong>埋め込み層</strong>(embedding layer)が使われる．以下の例では，10のカテゴリーをもつデータを，<span class="math inline">\(10\times5\)</span>の重み行列を用いて5次元の特徴に埋め込んでいる．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-98-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="自己アテンション" class="level3">
<h3 class="anchored" data-anchor-id="自己アテンション">自己アテンション</h3>
<p>自己アテンション(self attention)は，最近注目を浴びているトランスフォーマーの基礎となるアーキテクチャであり， 自然言語処理に大きな進歩をもたらした．</p>
<p>自己アテンションでは，入力された文章をLSTMのように順番に入力するのではなく，一度に読み込む． まず，入力された文字の埋め込みに，文字の位置情報を正弦・余弦曲線を用いて付加し， それに対してクエリー，キー，値を表す3つの全結合層を適用し，3つの行列（テンソル） <span class="math inline">\(Q,K,V\)</span> を得る． 次に，クエリ行列 <span class="math inline">\(Q\)</span> とキー行列 <span class="math inline">\(K\)</span> の内積をとり，それにスケーリングとソフトマックスを適用することによって，入力された文字同士の関係を表すアテンションを得る． 最後に，アテンションに値行列 <span class="math inline">\(V\)</span> を乗じることによって出力を得る．</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="16fastai_files/figure-html/cell-99-output-1.png" class="img-fluid"></p>
</div>
</div>
</section>
</section>
<section id="実践的な深層学習のレシピと背景にある理論" class="level2">
<h2 class="anchored" data-anchor-id="実践的な深層学習のレシピと背景にある理論">実践的な深層学習のレシピと背景にある理論</h2>
<p>上では例を示すことによって深層学習の「雰囲気」を学んだが、実際問題を解くためには、プロジェクトの進めるためのコツや、背景にある理論も理解する必要がある。 以下では、それらについて簡単に述べる。</p>
<section id="訓練検証テスト集合" class="level3">
<h3 class="anchored" data-anchor-id="訓練検証テスト集合">訓練、検証、テスト集合</h3>
<p>今までの例題では，データセットをトレーニング（訓練）集合とテスト集合の2つに分けていた． 研究や勉強のためには，この2つに分けるだけで十分であるが， 実際問題に適用する際には，訓練集合(training set)，検証集合(validation set)（開発集合(development set)とよばれることもある），テスト集合(test set)の3つにデータを分けて実験を行う必要がある． 訓練集合でパラメータ（重み）をチューニングし，検証集合で実際のデータでうまく動くようにハイパーパラメータをチューニングし，最後にテスト集合で評価する． テスト集合は実験では使用できないように隠しておく．検証集合は訓練集合から適当な割合で抽出しても良い．</p>
<p>昔は訓練集合は<span class="math inline">\(6\)</span>割、検証集合は <span class="math inline">\(2\)</span>割、テスト集合は <span class="math inline">\(2\)</span> 割と言われていた。しかし、最近はデータセットが大規模化しており、 検証とテストには一定数のデータセットがあれば十分である。例えば、超大規模データセットに対しては、 <span class="math inline">\(98\)</span>%を訓練、検証とテストには残りの<span class="math inline">\(1\)</span>%ずつとしても良い。</p>
</section>
<section id="バイアスとバリアンス-過剰適合と不足適合" class="level3">
<h3 class="anchored" data-anchor-id="バイアスとバリアンス-過剰適合と不足適合">バイアスとバリアンス / 過剰適合と不足適合</h3>
<p>深層学習の例題（MNISTとかCifarとか）では，現在の世界記録がどのあたりなのかが分かるが，実際問題においてどこまで学習を進めればよいのかは，一般には分からない．より一般的な最適化理論では，適当な緩和問題を用いた限界値（最小化の場合には下界）を得ることができるので，誤差を評価することができる．しかし，深層学習では，それが難しい場合が多い．そのような場合に，人でテストをしてみることによって，可能な誤差を推測することが推奨される．</p>
<p>人間がどんなに頑張っても出ないくらいの誤差（エラー率）をBayes最適誤差(Bayes” optimal error)とよぶ．</p>
<pre><code>バイアス  = 訓練誤差 - Bays最適誤差（もしくは人間水準誤差）
バリアンス = 検証誤差 - 訓練誤差</code></pre>
<p>バリアンスが大きい状態を<strong>過剰適合</strong>(overfit)とよぶ．バイアスが大きい状態を<strong>過小適合</strong>(underfit)とよび，これは訓練データに対する最適化が十分でないことを表す．</p>
<p>まずは訓練集合での正解率を上げることを目標に実験をするのだが，訓練データでの性能がいまいちな状態を「高バイアス」とよぶ．これを改善するには，ネットワークの規模を大きくして学習容量を大きくしたり，訓練時間を長くしたり，最適化の方法を変えたりすることが考えられる．</p>
<p>訓練データでそこそこの成績をあげられたら，今度は検証集合に対して性能を評価する．これがいまいちな状態が「高バリアンス」である． これを改善するには，データの量を増やしたり，正則化・正規化を行ったりすることが考えられる．これには色々な方法が考えられるが，深層学習で手軽なのはドロップアウトを追加したり，（確率的降下法の場合にはL2ノルムのかけ具合を表す）重み減衰パラメータを大きくしたり，バッチ正規化を行うことである．</p>
</section>
<section id="深層学習のレシピ" class="level3">
<h3 class="anchored" data-anchor-id="深層学習のレシピ">深層学習のレシピ</h3>
<p>深層学習プロジェクトを正しい方向に導くためには，多少のコツがある．ここでは，そのようなコツを伝授する．</p>
<p>検証集合におけるメトリクスが不十分なときに何をすれば良いだろうか？以下のような様々な方法が思いつく．</p>
<ul>
<li>より多くのデータを集める．</li>
<li>より多くの訓練集合を集める．</li>
<li>訓練により多くの時間をかける．</li>
<li>様々な最適化アルゴリズムを試す．</li>
<li>より大きなアーキテキクチャにしてみる．</li>
<li>アーキテキクチャを変更してみる．</li>
<li>ドロップアウト層を追加してみる．</li>
<li>L2正則化(regularization；重み減衰(weight decay)と同義語)を追加する．</li>
<li>バッチ正規化(batch normalization)を追加する．</li>
</ul>
<p>しかし，これらを場当たり的に適用しても時間がかかるばかりで，効果は上がらない．重要なのはアーキテクチャの選択とハイパーパラメータ（ニューラルネットでは調整する重みのことをパラメータとよび，それ以外のパラメータをハイパーパラメータとよぶ）の設定である．これには，以下の手順が推奨される．</p>
<ul>
<li><p>画像の場合には解像度を落とした小さなデータから始めて、徐々に解像度を上げていく。</p></li>
<li><p>訓練集合に対して損出関数を最小化する．できれば下限（人間の水準）に近づくようにする．これがうまくいかない場合には，学習率を適正な値に設定する。学習率が小さすぎると過少適合になり、大きすぎる最適化の探索が発散する。学習率を適正な値にしても、損出関数の値が想定よりも大きい場合には、より大規模なアーキテキクチャを試すか，異なる最適化手法を試す．バッチ正規化をアーキテクチャに追加し、最適化しやすいアーキテクチャ（残差ネットワークなど）を選択することも忘れてはならない。 メモリや計算速度が十分でないときには、単精度計算をするか、より大きなメモリをもつGPUに変更することを検討する。</p></li>
<li><p>転移学習を行っている場合には、固定していたパラメータを自由に変更できるようにしてから、再び訓練を行う。</p></li>
<li><p>（上の手順と並行して）検証集合に対して目的とする評価尺度（メトリクス）を達成するように訓練を行う．これがうまくいかない（過剰適合している）場合には，ドロップアウトを追加するか，重み減衰のパラメータを増やすか，訓練集合を増やすか，データ増大を行う．</p></li>
<li><p>テスト集合に対して良い結果が出るように訓練を行う．これがうまくいかない場合には，検証集合を増やすか，データ増大を行う．</p></li>
<li><p>実問題に対する性能評価を行う．これがうまくいかない場合には，検証集合やテスト集合が実問題を反映しているかどうかを調べ，適宜増やす．</p></li>
</ul>
<p>上ではいささか抽象的に手順を紹介したが，具体的なパラメータの適正化は以下の手順が推奨されている．</p>
<ol type="1">
<li><p>モデル（アーキテキクチャ）を選択する際には，解きたい問題に似た問題のベンチマークでの成績を https://dawn.cs.stanford.edu/benchmark/ やhttps://benchmarks.ai/ で調べて，そこで上位の（かつ簡単な）ものを選択する．たとえば，画像から物体を当てたい場合には，画像によるクラス分けならResNet（メモリに余裕があるならDenseNetやWide ResNet）をベースにしたもの，画像分類（セグメンテーション）ならUNETを選ぶ．</p></li>
<li><p>ただし競技会で上位のものは大規模なモデルを使用している場合が多い．モデルの規模が増大するにしたがい誤差は小さくなる（精度が上がる）が，その一方で計算時間が増加する．解くべき問題の複雑さを考慮してなるべく小さなモデルから始めて，十分な精度が得られなかったときに，大きめのモデルを試すという方法が推奨される．</p></li>
<li><p>すでに学習済みの重みがあるモデル（たとえばresnet34）を用い，転移学習を行う場合には，最終層以外の重みを変えないような状態で訓練を行う．学習率をlr_find()で可視化し，損出関数が下降している途中の範囲を求める．</p></li>
<li><p>得られた適正な学習率を用いて，最終層だけを数エポック訓練する．損出関数や精度の推移を可視化し，正しく訓練されていることを確認する．</p></li>
<li><p>上層も訓練できるように設定し，再びlr_find()で適切な学習率を探索する．</p></li>
<li><p>最下層を上で求めた学習率とし，上層の固まりは下層の固まりよりやや（画像の場合には10分の1，テキストの場合には0.26倍）小さめになるように設定し，過剰適合になるまで訓練する．（fastaiでは層のブロックを3層になるようにまとめている．）</p></li>
<li><p>すぐに過剰適合になっている場合には，それを抑止する方法を取り入れる必要がある．以下の順に試す.</p>
<ol type="1">
<li>もっとデータを集める．</li>
<li>データ増大を行う．</li>
<li>アーキテクチャ（モデル）にドロップアウト層やバッチ正規化を追加する．</li>
<li>正則化のためのハイパーパラメータ（重み減衰率: weight decay(wd)）を大きめにする．</li>
<li>アーキテクチャを単純化する．</li>
</ol></li>
<li><p>画像データの場合には，上の手順を解像度を下げて行い，徐々に解像度を上げて繰り返す．他の形式のデータの場合には，データの一部を用いて上の手順を行い，適切な結果が出たら大きなデータを入れて本実験を行う．</p></li>
</ol>
</section>
<section id="l2正則化重み減衰が過剰適合を削減する直感的な理由" class="level3">
<h3 class="anchored" data-anchor-id="l2正則化重み減衰が過剰適合を削減する直感的な理由">L2正則化（重み減衰）が過剰適合を削減する直感的な理由</h3>
<ol type="1">
<li><p>重み減衰率が大きくなると，重み <span class="math inline">\(w\)</span> は小さくなり，0になるものが増える．それによってニューラルネットがより疎になり，（ドロップアウトと同様に）過剰適合を削減する．</p></li>
<li><p>tanhなどの非線形な活性化関数を使っている場合，重み減衰率 <code>lambda</code> が大きくなると <span class="math inline">\(w\)</span> が小さくなるので，ニューロンへの入力も小さくなる（0に近くなる）．tanhなどの活性化関数を可視化すると分かるように0付近では線形関数に近い形をしている．したがって，非線形な活性化関数も線形関数と同じような働きをするようになり，これによって過剰適合が削減できる．</p></li>
</ol>
</section>
<section id="ハイパーパラメータのチューニング" class="level3">
<h3 class="anchored" data-anchor-id="ハイパーパラメータのチューニング">ハイパーパラメータのチューニング</h3>
<p>ハイパーパラメータは、以下の順で重要である。</p>
<ol type="1">
<li>学習率 (learning rate: lr)</li>
<li>慣性項（モーメント）(momentum)</li>
<li>ミニバッチの大きさ</li>
<li>隠れ層のユニット数</li>
<li>層の数</li>
<li>学習率の減らし方</li>
<li>正則化パラメータ (weight decay: wd)</li>
<li>活性化関数</li>
<li>Adamのパラメータ</li>
</ol>
<p>#hide ### データセット</p>
<p>fastaiで使用できるデータセットは、https://docs.fast.ai/data.external.html にまとめられている。ここでは、それらのうち重要なものを解説する。</p>
<p>これらのデータセットは、全てAWS(Amazon Web Service)のOpen Dataとして公開されている（https://registry.opendata.aws/）。 以下では，おおまかな分類ごとに</p>
<p>データセット名（読み込むときの文字列名；SAMPLE, TINYが最後につくものは小規模版）：解説</p>
<p>の形式で示す．</p>
<p>画像分類(image classification)</p>
<ul>
<li>MNIST(MNIST, MNIST_SAMPLE, MNIST_TINY, MNIST_VAR_SIZE_TINY)：<span class="math inline">\(28 \times 28\)</span> の手書き文字画像。画像分類で最初に扱われるデータセットである。</li>
<li>CIFAR10 (CIFAR) : 60000個の <span class="math inline">\(32 \times 32\)</span> のカラー画像であり、10種類の物体に分類する。</li>
<li>CIFAR100 (CIFAR_100): CIFAR10と同じであるが、100種類の物体に分類する。</li>
<li>Caltech-UCSD Birds-200-2011(CUB_200_2011)：200種類の鳥の種類を分類する。 物体検出(localization)にも使用できる。</li>
<li>Caltech 101 (CALTECH_101): 101種類のカテゴリーに分類する。物体検出にも使用できる。<br>
</li>
<li>Oxford-IIIT Pet (PETS)：27種類のペットを分類する。物体検出にも使用できる。</li>
<li>Oxford 102 Flowers (FLOWERS): 102種類の花の名前を分類する。画像は解像度が高い。<br>
</li>
<li>Food-101 (FOOD)：101種類の食べ物を分類する。</li>
<li>Stanford cars (CARS)：196種類の車を分類する。</li>
</ul>
<p>自然言語処理(natural language processing: NLP)</p>
<ul>
<li>IMDb Large Movie Review Dataset (IMDB, IMDB_SAMPLE)：映画の批評のテキストファイルを元にした感情分類用(sentiment classification)のデータセット。</li>
<li>Wikitext-103 (WIKITEXT WIKITEXT_TINY): Wikipediaから抽出された1億個のトークンから構成されるデータセット。言語モデリングで用いられる。</li>
<li>(AG_NEWS)<br>
</li>
<li>(AMAZON_REVIEWS)<br>
</li>
<li>(AMAZON_REVIEWS_POLARITY)</li>
<li>(DBPEDIA)<br>
</li>
<li>(MT_ENG_FRA)<br>
</li>
<li>(SOGOU_NEWS)<br>
</li>
<li>(YAHOO_ANSWERS)<br>
</li>
<li>(YELP_REVIEWS)<br>
</li>
<li>(YELP_REVIEWS_POLARITY)</li>
</ul>
<p>意味分割(semantic segmentation)</p>
<p>以下のデータセットは、与えられた画像の分割（各ピクセルがどの物体に属するのかを分類すること）に用いられる。</p>
<ul>
<li>Camvid: Motion-based Segmentation and Recognition Dataset (CAMVID, CAMVID_TINY)</li>
<li>PASCAL Visual Object Classes (VOC)</li>
<li>COCO - Common Objects in Context (COCO_SAMPLE, COCO_TINY) その他（サンプルや講義内で用いるデータ）</li>
<li>Planet (PLANET_SAMPLE, PLANET_TINY): 衛星画像から複数の説明を当てるデータ</li>
<li>Adult (ADULT_SAMPLE): 年収が500Kドル以上かどうかを当てる分類問題用の表形式データ</li>
<li>BIWI (BIWI_HEAD_POSE)：頭の中心を当てる回帰分析用のデータ</li>
<li>Movie Lens (ML_SAMPLE)：協調フィルタリング用の映画の評価値データ</li>
<li>Human Numbers (HUMAN_NUMBERS): RNN用の数字を英語で書いたデータ</li>
<li>Bedroom (LSUN_BEDROOMS) : GAN用の寝室画像データ</li>
</ul>
</section>
<section id="評価尺度メトリクス" class="level3">
<h3 class="anchored" data-anchor-id="評価尺度メトリクス">評価尺度（メトリクス）</h3>
<p>ここではfastaiで使われる代表的な評価尺度（メトリクス）について解説する．</p>
<ul>
<li>正解率 (accuracy)</li>
</ul>
<p>入力の中で最大値のクラスが正解クラスと一致している割合．正答率，精度と訳されることもある． 正解が1つのクラスに属しているとき（これを1ラベル問題とよぶ）に用いられる．</p>
<p>例： 入力として3つのクラスから成る5つのデータを与える．正解はすべてクラス1とする．入力の中で値が最大のものは，上のコードの中にあるようにargmaxメソッドで求めることができる．得られた(1,0,1,0,0)が正解(1,1,1,1,1)と一致している割合は 0.4 と計算できる．</p>
<div class="sourceCode" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>    <span class="im">from</span> fastai.metrics <span class="im">import</span> <span class="op">*</span></span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>    in_ <span class="op">=</span> torch.Tensor([ [<span class="fl">0.3</span>,<span class="fl">0.5</span>,<span class="fl">0.2</span>],</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>                         [<span class="fl">0.6</span>,<span class="fl">0.2</span>,<span class="fl">0.2</span>],</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>                         [<span class="fl">0.1</span>,<span class="fl">0.6</span>,<span class="fl">0.3</span>],</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>                         [<span class="fl">0.9</span>,<span class="fl">0.0</span>,<span class="fl">0.1</span>],</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>                         [<span class="fl">0.8</span>,<span class="fl">0.1</span>,<span class="fl">0.1</span>],</span>
<span id="cb125-7"><a href="#cb125-7" aria-hidden="true" tabindex="-1"></a>                        ])</span>
<span id="cb125-8"><a href="#cb125-8" aria-hidden="true" tabindex="-1"></a>    targs <span class="op">=</span> torch.Tensor([<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>]).<span class="bu">long</span>()</span>
<span id="cb125-9"><a href="#cb125-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(in_.argmax(dim<span class="op">=-</span><span class="dv">1</span>).view(<span class="dv">5</span>,<span class="op">-</span><span class="dv">1</span>))</span>
<span id="cb125-10"><a href="#cb125-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(accuracy(in_, targs))</span>
<span id="cb125-11"><a href="#cb125-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb125-12"><a href="#cb125-12" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span></span>
<span id="cb125-13"><a href="#cb125-13" aria-hidden="true" tabindex="-1"></a>    tensor([[<span class="dv">1</span>],</span>
<span id="cb125-14"><a href="#cb125-14" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>],</span>
<span id="cb125-15"><a href="#cb125-15" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">1</span>],</span>
<span id="cb125-16"><a href="#cb125-16" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>],</span>
<span id="cb125-17"><a href="#cb125-17" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>]])</span>
<span id="cb125-18"><a href="#cb125-18" aria-hidden="true" tabindex="-1"></a>    tensor(<span class="fl">0.4000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>2値分類の場合には， 正解か否か(true/false)と陽性と予測したか否か(positive/negative)があるので，以下の4通りの場合がある．</p>
<ul>
<li>TN : 真陰性 (true negative)</li>
<li>FP : 偽陽性 (false positive)</li>
<li>FN : 偽陰性 (false negative)</li>
<li>TP : 真陽性 (true positive)</li>
</ul>
<p>正解率は以下のように定義される．</p>
<p><span class="math display">\[
\mathrm{accuracy} = \frac{\mathrm{TP}+\mathrm{TN}}{\mathrm{TP}+\mathrm{FN}+\mathrm{FP}+\mathrm{TN}}
\]</span></p>
<ul>
<li>閾値付き正解率</li>
</ul>
<p>予測値に対するシグモイド関数の値が，与えた閾値（規定値は0.5）より大きいときに1，それ以外のとき0と計算し，その結果と正解を比較したときの正解率．</p>
<p>例： ランダムな標準正規分布として与えた5つの予測値に対してシグモイド関数で[0,1]の値に変換し，閾値0.5 より大きいものと正解を比較することによって，閾値付き正解率0.6を得る．</p>
<div class="sourceCode" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span> torch.randn(<span class="dv">5</span>)</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    y_true <span class="op">=</span> torch.Tensor([<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>]).<span class="bu">long</span>()</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"y_pred = "</span>, y_pred)</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"sigmoid = "</span>, y_pred.sigmoid())</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(accuracy_thresh(y_pred, y_true))</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span></span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>    y_pred <span class="op">=</span>  tensor([ <span class="fl">0.8596</span>,  <span class="fl">0.3210</span>, <span class="op">-</span><span class="fl">0.1176</span>,  <span class="fl">1.0431</span>, <span class="op">-</span><span class="fl">0.7974</span>])</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>    sigmoid <span class="op">=</span>  tensor([<span class="fl">0.7026</span>, <span class="fl">0.5796</span>, <span class="fl">0.4706</span>, <span class="fl">0.7394</span>, <span class="fl">0.3106</span>])</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>    tensor(<span class="fl">0.6000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>トップ <span class="math inline">\(k\)</span> 正解率</li>
</ul>
<p>入力値が大きいものからk個選択し，それらを正解と比較したときの正解率．</p>
<p>例： 正解率と同じ例題を用いる．トップ2のクラスを出力すると，正解の1は2番目には入っていないので，トップ1の正解率と同じ0.4を得る．</p>
<div class="sourceCode" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(in_.topk(k<span class="op">=</span><span class="dv">2</span>, dim<span class="op">=-</span><span class="dv">1</span>)[<span class="dv">1</span>])</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(top_k_accuracy(in_,targs,k<span class="op">=</span><span class="dv">2</span>))</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a><span class="op">&gt;&gt;&gt;</span></span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>    tensor([[<span class="dv">1</span>, <span class="dv">0</span>],</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, <span class="dv">2</span>],</span>
<span id="cb127-7"><a href="#cb127-7" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">1</span>, <span class="dv">2</span>],</span>
<span id="cb127-8"><a href="#cb127-8" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, <span class="dv">2</span>],</span>
<span id="cb127-9"><a href="#cb127-9" aria-hidden="true" tabindex="-1"></a>            [<span class="dv">0</span>, <span class="dv">2</span>]])</span>
<span id="cb127-10"><a href="#cb127-10" aria-hidden="true" tabindex="-1"></a>    tensor(<span class="fl">0.4000</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>ダイス係数(dice coefficient)</li>
</ul>
<p>分割問題で用いられる集合の類似度を表す評価尺度であり，引数 iou (intersection over union) が真のときには，以下のように計算する．</p>
<p><span class="math display">\[DICE(A,B)=\frac{|A \cap B|}{|A|+|B|-|A \cap B| + 1 }\]</span></p>
<p>引数iouが偽（既定値）のときには，以下のように計算する．</p>
<p><span class="math display">\[DICE(A,B)=\frac{2|A \cap B|}{|A|+|B|}\]</span></p>
<p>例：</p>
<pre class="phython"><code>    print("iou=False:", dice(in_,targs,iou=False))
    print("iou=True:",dice(in_,targs,iou=True))

&gt;&gt;&gt;
    iou=False: tensor(0.5714)
    iou=True: tensor(0.3333)</code></pre>
<ul>
<li>誤差率 (error rate)</li>
</ul>
<p><span class="math inline">\(1-\)</span>正解率であり，上の例題では<span class="math inline">\(1-0.4=0.6\)</span>となる．</p>
<ul>
<li>決定係数(coefficient of determination) <span class="math inline">\(R^2\)</span></li>
</ul>
<p>回帰モデルによって実データをどれくらい説明できているか（回帰分析の精度）を表す指標であり，1に近いほど精度が良いと解釈できる．</p>
<p><span class="math display">\[R^2 = 1 - {\sum_{i=1}^n (y_i - \hat{y}_i)^2 \over \sum_{i=1}^n (y_i-\bar{y})^2 }\]</span></p>
<p>この定義だと（記号が<span class="math inline">\(R^2\)</span>であるにもかかわらず）負になる場合もあるので，注意を要する．最大値は1で誤差が0の状態である．<span class="math inline">\(R^2\)</span>が0とは，平均で予測をした場合と同じ精度という意味であり，負の場合は平均値より悪い予測を意味する．</p>
<ul>
<li>平均自乗誤差 (mean squared error)</li>
</ul>
<p>誤差の自乗の平均値であり，<span class="math inline">\(i\)</span>番目のデータの正解（目標値）を<span class="math inline">\(y_i\)</span>，予測値を<span class="math inline">\(\hat{y}_{i}\)</span> としたとき，以下のように定義される．</p>
<p><span class="math display">\[MSE = \frac{\sum_{i=1}^n (\hat y_i - y_i)^2}{n}\]</span></p>
<p>これの平方根をとったものがroot_mean_squared_error (RMSE) である．</p>
<p><span class="math display">\[RMSE =\sqrt{\frac{\sum_{i=1}^n (\hat y_i - y_i)^2}{n}}\]</span></p>
<ul>
<li>平均絶対誤差 (mean absolute error)</li>
</ul>
<p>誤差の絶対値の平均値である．</p>
<p><span class="math display">\[MAE = \frac{\sum_{i=1}^n |\hat y_i - y_i|}{n}\]</span></p>
<ul>
<li>平均自乗対数誤差 (mean squared logarithmic error)</li>
</ul>
<p>予測値，正解ともに対数をとったもので評価した平均自乗誤差である．</p>
<p>これの平方根をとったものがroot mean squared logarithmic error (RMSLE) である．</p>
<ul>
<li>MAPE 平均絶対パーセント誤差 (mean absolute percentage error)</li>
</ul>
<p><span class="math display">\[MAPE = \frac{\sum_{i=1}^n | (\hat y_i - y_i)/y_i) |}{n}\]</span></p>
<ul>
<li>適合率 (precision)：正と予測したデータのうち，実際に正であるものの割合</li>
</ul>
<p><span class="math display">\[
     \mathrm{precision} = \frac{\mathrm{TP}}{\mathrm{TP}+\mathrm{FP}}
\]</span></p>
<ul>
<li>再現率 (recall)：実際に正であるもののうち，正であると予測されたものの割合</li>
</ul>
<p><span class="math display">\[
\mathrm{recall} = \frac{\mathrm{TP}}{\mathrm{TP}+\mathrm{FN}}
\]</span></p>
<ul>
<li><span class="math inline">\(f\)</span>ベータ</li>
</ul>
<p>適合率と再現率をパラメータ <span class="math inline">\(\beta\)</span> で調整した評価尺度であり，主に2値分類で用いられる．</p>
<p><span class="math display">\[f_\beta = (1 + \beta^2)  \frac{\mathrm{precision} \cdot \mathrm{recall}}{(\beta^2 \mathrm{precision}) + \mathrm{recall}}\]</span></p>
<ul>
<li>寄与率(explained variance)</li>
</ul>
<p>「<span class="math inline">\(1 -\)</span>誤差の分散/正解の分散」と定義される．</p>
<section id="自分で新しい評価尺度を作る方法" class="level4">
<h4 class="anchored" data-anchor-id="自分で新しい評価尺度を作る方法">自分で新しい評価尺度を作る方法</h4>
<p>他の評価尺度から新たに評価尺度を生成するには，標準モジュールのfunctoolsにあるpartialを使うと簡単にできる．fastaiではすでにimportした状態にあるので，以下のように呼び出せば良い．</p>
<div class="sourceCode" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>    acc_02 <span class="op">=</span> partial(accuracy_thresh, thresh<span class="op">=</span><span class="fl">0.2</span>)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>    f_05 <span class="op">=</span> partial(fbeta, beta<span class="op">=</span><span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>最初の行では，閾値付き正解率に対して，閾値を0.2に固定した評価尺度acc_02を生成し，次の行ではfベータ のパラメータ（beta) を0.5に固定した評価尺度f_05を生成している．</p>


</section>
</section>
</section>

</main> <!-- /main -->
<script type="application/vnd.jupyter.widget-state+json">
{"state":{},"version_major":2,"version_minor":0}
</script>
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>